<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/common.css" />
    <title>Âæ©Áøí - ÊñáÊ≥ïÁ∑¥Áøí</title>
    <style>
      * {
        box-sizing: border-box;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .choice {
        display: block;
        margin: 8px 0;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s, transform 0.1s ease-out;
      }

      .choice:hover {
        background-color: var(--explanation-bg);
        border-color: var(--link-color);
      }
      .choice.selected {
        transform: scale(1.02);
      }

      .choice.correct {
        background-color: var(--correct-bg);
        color: var(--correct-text);
        border-color: var(--correct-text);
        font-weight: bold;
        transform: scale(1); /* Reset scale */
      }

      .choice.wrong {
        background-color: var(--wrong-bg);
        color: var(--wrong-text);
        border-color: var(--wrong-text);
        font-weight: bold;
        transform: scale(1); /* Reset scale */
      }

      #quiz-container,
      #final-result {
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--card-bg);
        box-shadow: var(--shadow);
        margin-top: 20px;
      }

      #quiz-settings {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .settings-group {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }
      .settings-group label {
        font-weight: bold;
      }
      .settings-group input[type="text"],
      .settings-group input[type="number"] {
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
      }
      .review-mode-options {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .final-question-item {
        border: 1px solid var(--border-color);
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        background-color: var(--card-bg);
      }
      .final-question-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
      }
      .final-question-item:hover {
        background-color: var(--button-hover-bg);
        cursor: pointer;
      }

      #question-status-bar {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .status-box {
        width: 28px;
        height: 28px;
        border: 1px solid var(--border-color);
        background-color: #e0e0e0; /* X√°m: Ch∆∞a tr·∫£ l·ªùi */
        margin: 2px;
        cursor: pointer;
        text-align: center;
        line-height: 26px;
        font-size: 12px;
        font-weight: bold;
        color: #555;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      .dark-mode .status-box {
        background-color: #555;
        color: #ccc;
      }
      .status-box.correct {
        background-color: var(--correct-bg);
      } /* Xanh: ƒê√∫ng */
      .status-box.wrong {
        background-color: var(--wrong-bg);
      } /* ƒê·ªè: Sai */
      .status-box.current {
        border: 2px solid #007bff; /* Vi·ªÅn xanh: C√¢u hi·ªán t·∫°i */
      }
      .status-box.flagged {
        position: relative;
      }
      .status-box.flagged::after {
        content: "üö©";
        position: absolute;
        top: -10px;
        right: -8px;
        font-size: 12px;
      }
      #flag-btn.active {
        background-color: var(--warning-color);
      }
      #favorite-btn {
        color: #aaa;
        border-color: #aaa;
        transition: all 0.2s;
      }
      #favorite-btn.active {
        color: #ffc107;
        border-color: #ffc107;
        background-color: #fffbe5;
        transform: scale(1.1);
      }
      .dark-mode #favorite-btn.active { background-color: #4a420c; }

      /* CSS cho modal xem l·∫°i chi ti·∫øt */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.25s ease-in-out;
      }
      .modal-content {
        background-color: var(--card-bg);
        margin: auto;
        padding: 20px;
        border: 1px solid var(--border-color);
        width: 90%;
        max-width: 700px;
        border-radius: 8px;
        box-shadow: var(--shadow);
      }
      .modal.show {
        display: flex;
        opacity: 1;
      }

      .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close-btn:hover,
      .close-btn:focus {
        color: black;
        text-decoration: none;
      }
      #review-passage-content {
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        padding: 15px;
        margin-bottom: 20px;
      }

      /* CSS cho modal s·ª≠a c√¢u h·ªèi */
      #editQuestionModal .modal-content {
        max-width: 600px;
        display: flex; /* ƒê√£ c√≥ */
        flex-direction: column;
        max-height: 90vh;
      }
      #editQuestionModal input[type="text"],
      #editQuestionModal input[type="number"],
      #editQuestionModal [contenteditable="true"] {
        width: 100%;
        padding: 10px;
        margin: 4px 0 10px 0;
        box-sizing: border-box;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background-color: var(--input-bg);
        color: var(--text-color);
        white-space: pre-wrap;
      }

      #editQuestionModal .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1; /* Cho ph√©p body co gi√£n ƒë·ªÉ l·∫•p ƒë·∫ßy kh√¥ng gian */
      }
      #editQuestionModal .modal-footer {
        padding: 10px 20px;
        border-top: 1px solid #eee;
        text-align: right;
        flex-shrink: 0; /* Kh√¥ng cho footer co l·∫°i */
        background-color: transparent; /* ƒê·ªìng b·ªô m√†u n·ªÅn v·ªõi ph·∫ßn c√≤n l·∫°i c·ªßa modal */
      }
      .explanation {
        margin-top: 15px;
        padding: 10px;
        background-color: var(--explanation-bg);
        border-radius: 4px;
      }

      #button-bar {
        margin-top: 20px;
        /* --- C·ªë ƒë·ªãnh thanh ƒëi·ªÅu khi·ªÉn ·ªü cu·ªëi m√†n h√¨nh --- */
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
        background-color: var(--card-bg);
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        z-index: 990;
        text-align: center; /* Gi·ªØ nguy√™n cƒÉn gi·ªØa */
      }

      #start-btn {
        padding: 10px 25px;
        font-size: 1.1em;
      }

      #timer-display {
          font-size: 1.5em;
          font-weight: bold;
          color: var(--primary-bg);
          text-align: center;
          margin-bottom: 15px;
          padding: 5px 10px;
          background-color: var(--explanation-bg);
          border-radius: 6px;
          min-width: 80px;
          display: inline-block;
          position: absolute;
          right: 20px;
      }

      /* Responsive adjustments for mobile */
      @media (max-width: 768px) {
        .settings-group,
        .review-mode-options {
          flex-direction: column;
          align-items: flex-start;
        }
        #button-bar {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 5px; /* Small gap between buttons */
        }
        #button-bar button {
          font-size: 1.2em; /* Larger icon */
          padding: 10px; /* Make buttons more square */
          min-width: 50px; /* Ensure a minimum width for icon-only buttons */
          min-height: 50px; /* Ensure a minimum height */
          gap: 0; /* Remove gap between icon and text */
        }
        #button-bar .button-text {
          display: none; /* Hide text on small screens */
        }
        /* Hi·ªÉn th·ªã container c·ªßa n√∫t "Th√™m t√πy ch·ªçn" ch·ªâ tr√™n di ƒë·ªông */
        #more-options-container {
            display: inline-flex;
        }

        /* ·∫®n c√°c n√∫t ri√™ng l·∫ª tr√™n di ƒë·ªông (v√¨ ch√∫ng ƒë√£ n·∫±m trong menu) */
        #submit-btn, #unanswered-btn, #flag-btn, #favorite-btn, #exit-btn {
            display: none !important;
        }
        #more-options-container {
          position: relative; /* Anchor for the menu */
          display: none; /* Hidden by default, shown via JS and media query */
        }
        #more-options-menu {
          position: absolute;
          bottom: 120%; /* Position above the button bar */
          left: 50%;
          background-color: var(--card-bg);
          border-radius: 8px;
          box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
          z-index: 1000;
          width: 200px;
          padding: 5px;
          border: 1px solid var(--border-color);
          /* Animation properties */
          opacity: 0;
          visibility: hidden;
          transform: translateX(-50%) translateY(10px);
          transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0.2s;
        }
        #more-options-menu.active {
          opacity: 1;
          visibility: visible;
          transform: translateX(-50%) translateY(0);
        }
        #more-options-menu button {
          display: flex; /* Use flex for alignment */
          width: 100%;
          justify-content: flex-start; /* Align text to the left */
          text-align: left;
          padding: 12px;
          font-size: 1em; /* Reset font size for menu items */
          min-height: auto; /* Reset min-height */
        }
        #more-options-menu .button-text {
          display: inline; /* Show text inside the menu */
        }

        /* --- Input with clear button --- */
        .input-with-clear-container {
          position: relative;
          display: flex;
          align-items: center;
        }
        .input-with-clear-container input[type="text"] {
          padding-right: 30px; /* Make space for the 'x' button */
        }
        .clear-btn {
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          cursor: pointer;
          font-size: 22px;
          color: #999;
          line-height: 1;
          display: none; /* Hidden by default */
        }
        .clear-btn:hover { color: #333; }
        .dark-mode .clear-btn:hover { color: #fff; }
      }

      /* Quy t·∫Øc cho m√†n h√¨nh l·ªõn h∆°n (Desktop) */
      @media (min-width: 769px) {
          /* ·∫®n container c·ªßa n√∫t "Th√™m t√πy ch·ªçn" tr√™n desktop */
          #more-options-container { display: none !important; }
      }

      /* --- Highlight & Note Toolbar --- */
      #highlight-toolbar {
        position: absolute;
        display: none;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: var(--shadow);
        padding: 5px;
        z-index: 1010;
      }
      #highlight-toolbar button {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        font-size: 1.2em;
      }
      #highlight-toolbar button:hover {
        background-color: var(--button-hover-bg);
      }
      #highlight-toolbar .color-palette {
        display: flex;
        gap: 5px;
      }
      #highlight-toolbar .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: transform 0.1s;
      }
      #highlight-toolbar .color-swatch:hover {
        transform: scale(1.15);
      }

      mark {
        background-color: #fff8b9; /* M√†u v√†ng m·∫∑c ƒë·ªãnh */
        color: inherit;
        padding: 1px 0;
        border-radius: 3px;
      }
      /* C√°c m√†u highlight kh√°c nhau */
      mark[data-color="yellow"] { background-color: #fff8b9; }
      mark[data-color="pink"]   { background-color: #ffcce7; }
      mark[data-color="blue"]   { background-color: #cce5ff; }
      mark[data-color="green"]  { background-color: #d4edda; }
      mark[data-color="purple"] { background-color: #e2d9f3; }

      /* C·∫£i thi·ªán ƒë·ªô t∆∞∆°ng ph·∫£n cho highlight trong dark mode */
      .dark-mode mark {
        color: #212529; /* Ch·ªØ m√†u t·ªëi tr√™n n·ªÅn highlight s√°ng */
      }


      /* --- Multi-select highlight for editing --- */
      .multi-select-highlight {
          background-color: #cce5ff; /* M√†u xanh nh·∫°t ƒë·ªÉ ph√¢n bi·ªát v·ªõi highlight ƒë·ªçc */
          color: inherit;
      }

      /* --- Ki·ªÉu d√°ng cho n√∫t "Ch·ªçn nhi·ªÅu" khi active --- */
      button.active[onclick*="toggleMultiSelectMode"] {
          background-color: var(--primary-bg);
          color: var(--primary-text);
          border-color: var(--primary-hover);
          box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
      }
      /* Thay ƒë·ªïi icon khi active */
      button.active[onclick*="toggleMultiSelectMode"]::before {
          content: '‚úÖ';
      }
      button[onclick*="toggleMultiSelectMode"]::before {
          content: '‚ú®';
      }
    </style>
  </head>

  <body class="preload">
    <!-- Placeholder for the header component -->
    <header class="app-header">
      <div class="header-content">
        <div id="breadcrumbs" class="breadcrumbs"></div>
        <nav id="common-nav" class="nav-menu-desktop"></nav>
        <div class="header-actions">
          <button id="theme-toggle-desktop"
            onclick="toggleTheme()">üåô</button>
        </div>
      </div>
    </header>
    <!-- C√°c n√∫t ƒëi·ªÅu khi·ªÉn v√† menu cho di ƒë·ªông -->
    <div class="mobile-controls">
      <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
      <button id="hamburger-menu" onclick="toggleMobileMenu()">‚ò∞</button>
    </div>
    <div id="mobile-menu-overlay" onclick="toggleMobileMenu()">
      <nav id="nav-menu-mobile" class="nav-menu-mobile"></nav>
    </div>

    <div class="container">

      <h2>üìñ √în t·∫≠p ng·ªØ ph√°p</h2>

      <div id="quiz-settings">
        <div class="settings-group">
          <label class="custom-checkbox">
            <input type="checkbox"
              id="enable-keyword-filter" /><span>L·ªçc c√¢u h·ªèi theo t·ª´
              kh√≥a:</span>
          </label>
          <div class="input-with-clear-container" style="flex-grow: 1;">
            <input
              type="text"
              id="review-search-input"
              placeholder="Nh·∫≠p t·ª´ kh√≥a..."
              style="width: 100%;"
              disabled />
            <span id="clear-search-btn" class="clear-btn"
              title="X√≥a">&times;</span>
          </div>
          <span id="filtered-questions-count"
            style="margin-left: 10px"></span>
        </div>
        <div class="settings-group">
          <label class="custom-checkbox">
            <input type="checkbox" id="enable-tag-filter" /><span>L·ªçc theo
              Tag:</span>
          </label>
          <select id="tag-filter" disabled>
            <option value>T·∫•t c·∫£ c√°c Tag</option>
            <!-- C√°c tag s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
          </select>
        </div>
        <div class="settings-group">
          <label for="max-questions">Nh·∫≠p s·ªë c√¢u h·ªèi mu·ªën l√†m (t·ªïng c·ªông
            c√≥
            <span id="total-questions-count">0</span> c√¢u):</label>
          <input type="number" id="max-questions" min="1"
            style="width: 80px" />
        </div>
        <div class="settings-group">
          <label>Ch·∫ø ƒë·ªô √¥n t·∫≠p:</label>
          <div class="review-mode-options">
            <label class="custom-checkbox">
              <input type="checkbox" id="random-mode"
                checked /><span>Ng·∫´u nhi√™n (x√°o tr·ªôn c√¢u h·ªèi)</span>
            </label>
            <label class="custom-checkbox">
              <input type="checkbox"
                id="exclude-mastered-questions" /><span>·∫®n c√°c c√¢u ƒë√£ n·∫Øm r√µ
                (l√†m > 5 l·∫ßn, ƒë√∫ng > 75%)</span>
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" id="favorites-only" /><span>‚≠ê Ch·ªâ √¥n t·∫≠p
                c√°c c√¢u ƒë√£ g·∫Øn sao</span>
            </label>
          </div>
        </div>
        <div class="settings-group">
          <label>C√†i ƒë·∫∑t th·ªùi gian:</label>
          <div class="review-mode-options">
            <label class="custom-checkbox">
              <input type="checkbox" id="enable-single-timer" checked />
              <span>B·∫≠t ƒë·∫øm ng∆∞·ª£c cho c√¢u h·ªèi ƒë∆°n:</span>
            </label>
            <input type="number" id="single-timer-seconds" value="30" min="5"
              style="width: 70px;" />
            <span>gi√¢y</span>
          </div>
          <div class="review-mode-options" style="margin-top: 10px;">
            <label class="custom-checkbox">
              <input type="checkbox" id="enable-passage-timer" />
              <span>B·∫≠t ƒë·∫øm ng∆∞·ª£c cho b√†i ƒë·ªçc:</span>
            </label>
            <input type="number" id="passage-timer-minutes" value="5" min="1"
              style="width: 70px;" disabled />
            <span>ph√∫t</span>
          </div>
        </div>
      </div>

      <div id="quiz-container" style="display: none">
        <div id="question-status-bar"></div>
        <div
          id="score"
          style="margin-bottom: 15px; font-size: 1.1em; font-weight: bold"></div>
        <div id="passage-content" style="display: none"></div>
        <div id="timer-display" style="display: none;"></div>
        <div id="quiz"></div>
        <div
          id="edit-button-container"
          style="margin-top: 15px; text-align: right"></div>
      </div>

      <div id="final-result" style="display: none">
        <h3>üéâ Ho√†n th√†nh!</h3>
        <p id="final-score" style="font-size: 1.2em"></p>
        <p id="average-time-stat" style="font-style: italic;"></p>
        <label class="custom-checkbox"
          style="margin: 10px 0; display: inline-flex">
          <input
            type="checkbox" id="hide-correct-answers"
            onchange="showFinalResult()" /><span>·∫®n c√°c c√¢u tr·∫£ l·ªùi
            ƒë√∫ng</span>
        </label>
        <div id="final-answers-list"></div>
      </div>

      <br />
      <div id="button-bar" style="text-align: center">
        <button id="start-btn" onclick="shuffleAndStart()" class="btn-primary"
          title="B·∫Øt ƒë·∫ßu √¥n t·∫≠p">
          <span class="button-icon">üé≤</span> <span class="button-text">B·∫Øt
            ƒë·∫ßu</span>
        </button>
        <button id="prev-btn" onclick="prev()" style="display: none"
          title="C√¢u tr∆∞·ªõc">
          <span class="button-icon">‚óÄÔ∏è</span> <span class="button-text">Quay
            l·∫°i</span>
        </button>
        <button id="next-btn" onclick="next()" style="display: none"
          title="C√¢u ti·∫øp theo">
          <span class="button-text">Ti·∫øp theo</span> <span
            class="button-icon">‚ñ∂Ô∏è</span>
        </button>

        <!-- Container for more options button on mobile -->
        <div id="more-options-container" style="display: none;">
          <button id="more-options-btn" onclick="toggleMoreOptionsMenu(event)"
            title="Th√™m t√πy ch·ªçn">
            <span class="button-icon">‚ãÆ</span>
          </button>
          <div id="more-options-menu">
            <!-- The buttons will be cloned here by JS, but we can have them for structure -->
            <button id="submit-btn-menu" onclick="submitQuiz()"
              title="N·ªôp b√†i v√† xem k·∫øt qu·∫£"><span class="button-icon">üìù</span>
              <span class="button-text">N·ªôp b√†i</span></button>
            <button id="unanswered-btn-menu" onclick="findNextUnanswered()"
              title="ƒêi ƒë·∫øn c√¢u ch∆∞a tr·∫£ l·ªùi ti·∫øp theo">
              <span class="button-icon">üîç</span> <span class="button-text">Ch∆∞a
                tr·∫£ l·ªùi</span>
            </button>
            <button id="flag-btn-menu" onclick="toggleFlag()"
              title="ƒê√°nh d·∫•u c√¢u h·ªèi ƒë·ªÉ xem l·∫°i sau">
              <span class="button-icon">üö©</span> <span class="button-text">ƒê√°nh
                d·∫•u</span>
            </button>
            <button id="favorite-btn-menu" onclick="toggleFavorite()"
              title="Th√™m v√†o danh s√°ch y√™u th√≠ch">
              <span class="button-icon">‚≠ê</span> <span class="button-text">G·∫Øn
                sao</span>
            </button>
            <button id="exit-btn-menu" onclick="exitQuiz()"
              title="Tho√°t kh·ªèi l∆∞·ª£t √¥n t·∫≠p">
              <span class="button-icon">üö™</span> <span
                class="button-text">Tho√°t</span>
            </button>
          </div>
        </div>

        <!-- These buttons are for desktop view and will be hidden on mobile. N√∫t N·ªôp b√†i kh√¥ng c√≥ class m√†u ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi c√°c n√∫t kh√°c -->
        <button id="submit-btn" onclick="submitQuiz()" style="display: none"
          title="N·ªôp b√†i v√† xem k·∫øt qu·∫£"><span class="button-icon">üìù</span>
          <span class="button-text">N·ªôp b√†i</span></button>
        <button id="unanswered-btn" onclick="findNextUnanswered()"
          style="display: none" title="ƒêi ƒë·∫øn c√¢u ch∆∞a tr·∫£ l·ªùi ti·∫øp theo"><span
            class="button-icon">üîç</span> <span class="button-text">Ch∆∞a tr·∫£
            l·ªùi</span></button>
        <button id="flag-btn" onclick="toggleFlag()" style="display: none"
          title="ƒê√°nh d·∫•u c√¢u h·ªèi ƒë·ªÉ xem l·∫°i sau"><span
            class="button-icon">üö©</span> <span class="button-text">ƒê√°nh
            d·∫•u</span></button>
        <button id="favorite-btn" onclick="toggleFavorite()"
          style="display: none" title="Th√™m v√†o danh s√°ch y√™u th√≠ch"><span
            class="button-icon">‚≠ê</span> <span class="button-text">G·∫Øn
            sao</span></button>
        <button id="exit-btn" onclick="exitQuiz()" style="display: none"
          title="Tho√°t kh·ªèi l∆∞·ª£t √¥n t·∫≠p"><span class="button-icon">üö™</span>
          <span class="button-text">Tho√°t</span></button>

        <button id="next-btn" onclick="next()" style="display: none"
          title="C√¢u ti·∫øp theo">
          <span class="button-text">Ti·∫øp theo</span> <span
            class="button-icon">‚ñ∂Ô∏è</span>
        </button>
      </div>

    </div> <!-- End .container -->

    <!-- Modal ƒë·ªÉ xem l·∫°i chi ti·∫øt c√¢u h·ªèi -->
    <div id="review-detail-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" title="ƒê√≥ng"
          onclick="closeReviewDetailModal()">√ó</span>
        <div id="review-passage-content" style="display: none"></div>
        <div id="review-question-detail"></div>
      </div>
    </div>

    <!-- Modal ƒë·ªÉ s·ª≠a c√¢u h·ªèi ƒë∆°n -->
    <div id="editQuestionModal" class="modal">
      <div class="modal-content">
        <div class="modal-body">
          <h3 style="margin-top: 0">‚úèÔ∏è S·ª≠a c√¢u h·ªèi</h3>
          <label for="editQ">C√¢u h·ªèi:</label>
          <div id="toolbarEditQ"
            style="margin-top: 2px; margin-bottom: 5px">
            <button
              type="button"
              onclick="toggleMultiSelectMode(this, 'editQ')">              
              ‚ú® Ch·ªçn nhi·ªÅu
            </button>
            <button type="button"
              onclick="formatEdit('bold', 'editQ')">
              <b>B</b>
            </button>
            <button type="button"
              onclick="formatEdit('underline', 'editQ')">
              <u>U</u>
            </button>
            <button
              type="button"
              onclick="formatEdit('strikeThrough', 'editQ')">
              <s>S</s>
            </button>
          </div>
          <div id="editQ" contenteditable="true"
            style="min-height: 60px"></div>

          <label for="editC1">ƒê√°p √°n 1:</label>
          <input type="text" id="editC1" />
          <label for="editC2">ƒê√°p √°n 2:</label>
          <input type="text" id="editC2" />
          <label for="editC3">ƒê√°p √°n 3:</label>
          <input type="text" id="editC3" />
          <label for="editC4">ƒê√°p √°n 4:</label>
          <input type="text" id="editC4" />

          <label for="editCorrect">ƒê√°p √°n ƒë√∫ng (1-4):</label>
          <input type="number" id="editCorrect" min="1" max="4" />

          <label for="editExplanation">Gi·∫£i th√≠ch:</label>
          <div
            id="toolbarEditExplanation"
            style="margin-top: 2px; margin-bottom: 5px">
            <button
              type="button"
              onclick="toggleMultiSelectMode(this, 'editExplanation')">              
              ‚ú® Ch·ªçn nhi·ªÅu
            </button>
            <button
              type="button"
              onclick="formatEdit('bold', 'editExplanation')">
              <b>B</b>
            </button>
            <button
              type="button"
              onclick="formatEdit('underline', 'editExplanation')">
              <u>U</u>
            </button>
            <button
              type="button"
              onclick="formatEdit('strikeThrough', 'editExplanation')">
              <s>S</s>
            </button>
          </div>
          <div
            id="editExplanation"
            contenteditable="true"
            style="min-height: 60px"></div>
        </div>
        <div class="modal-footer">
          <button
            onclick="saveEdit()"
            style="
              background-color: var(--primary-bg);
              color: var(--primary-text);
            ">
            üíæ L∆∞u
          </button>
          <button onclick="closeEditModal()">‚úñ H·ªßy</button>
        </div>
      </div>
    </div>

    <!-- Modal ƒë·ªÉ s·ª≠a B√ÄI ƒê·ªåC -->
    <div id="editPassageModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-body">
          <h3 style="margin-top: 0">‚úèÔ∏è S·ª≠a b√†i ƒë·ªçc</h3>

          <label for="passageEditText"><b>N·ªôi dung b√†i
              ƒë·ªçc:</b></label>
          <div
            id="passageEditText"
            contenteditable="true"
            style="
              min-height: 150px;
              white-space: pre-wrap;
              border: 1px solid var(--border-color);
              padding: 8px;
              border-radius: 4px;
            "></div>
          <br />

          <label for="passageEditSubQuestions"><b>C√°c c√¢u h·ªèi cho b√†i
              ƒë·ªçc (gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng):</b></label>
          <div id="toolbarPassageEdit" style="margin-bottom: 5px">
            <button
              onclick="toggleMultiSelectMode(this, 'passageEditSubQuestions')">
              ‚ú® Ch·ªçn nhi·ªÅu              
            </button>
            <button
              onclick="formatEdit('bold', 'passageEditSubQuestions')">
              <b>B</b>
            </button>
            <button
              onclick="formatEdit('underline', 'passageEditSubQuestions')">
              <u>U</u>
            </button>
            <button
              onclick="formatEdit('strikeThrough', 'passageEditSubQuestions')">
              <s>S</s>
            </button>
          </div>
          <div
            id="passageEditSubQuestions"
            contenteditable="true"
            style="
              min-height: 200px;
              white-space: pre-wrap;
              border: 1px solid var(--border-color);
              padding: 8px;
              border-radius: 4px;
            "></div>
        </div>
        <div class="modal-footer">
          <button onclick="savePassageEdit()" class="btn-primary"> üíæ L∆∞u thay
            ƒë·ªïi </button>
          <button onclick="closeEditPassageModal()">‚úñ ƒê√≥ng</button>
        </div>
      </div>
    </div>

    <!-- Toolbar cho ch·ª©c nƒÉng highlight -->
    <div id="highlight-toolbar">
        <div class="color-palette">
            <span class="color-swatch" style="background-color: #fff8b9;" onclick="applyHighlight('yellow')"></span>
            <span class="color-swatch" style="background-color: #ffcce7;" onclick="applyHighlight('pink')"></span>
            <span class="color-swatch" style="background-color: #cce5ff;" onclick="applyHighlight('blue')"></span>
            <span class="color-swatch" style="background-color: #d4edda;" onclick="applyHighlight('green')"></span>
            <span class="color-swatch" style="background-color: #e2d9f3;" onclick="applyHighlight('purple')"></span>
        </div>
        <button onclick="removeHighlight()" title="X√≥a t√¥ s√°ng">üóëÔ∏è</button>
    </div>

    <script
      src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- T·∫£i c·∫•u h√¨nh v√† kh·ªüi t·∫°o Firebase t·ª´ file ri√™ng -->
    <script src="./js/firebase-init.js"></script>
    <script src="./js/common.js"></script>

    <script>
      let allQuestions = []; // T·∫£i t·ª´ Firestore
      let quizQuestions = [];
      let filteredQuestions = []; // L∆∞u danh s√°ch c√¢u h·ªèi ƒë√£ l·ªçc
      let index = 0;
      let correctCount = 0;
      let incorrectCount = 0;
      let timerInterval;
      let questionStartTime;
      let singleQuestionTimes = [];

      let isMultiSelectMode = false;
      // Kh√¥i ph·ª•c phi√™n l√†m b√†i n·∫øu c√≥
      if (restoreQuizSession()) {
        // N·∫øu kh√¥i ph·ª•c th√†nh c√¥ng, kh√¥ng c·∫ßn l√†m g√¨ th√™m ·ªü ƒë√¢y
      }

      // H√†m t·∫£i d·ªØ li·ªáu t·ª´ Firestore
      async function loadAllQuestions() {
        try {
          const filteredIdsJSON = sessionStorage.getItem("filteredQuestionIds");
          let isFilteredMode = false;

          if (filteredIdsJSON) {
            const filteredIds = JSON.parse(filteredIdsJSON);
            if (filteredIds.length > 0) {
              // T·∫£i c√°c c√¢u h·ªèi c·ª• th·ªÉ d·ª±a tr√™n ID ƒë√£ l·ªçc
              const promises = filteredIds.map((id) =>
                questionsCollection.doc(id).get()
              );
              const docSnapshots = await Promise.all(promises);
              allQuestions = docSnapshots.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              isFilteredMode = true;
            }
            // X√≥a b·ªô nh·ªõ ƒë·ªám sau khi s·ª≠ d·ª•ng ƒë·ªÉ l·∫ßn sau kh√¥ng b·ªã ·∫£nh h∆∞·ªüng
            sessionStorage.removeItem("filteredQuestionIds");
          }

          if (!isFilteredMode) {
            // T·∫£i t·∫•t c·∫£ c√¢u h·ªèi nh∆∞ b√¨nh th∆∞·ªùng n·∫øu kh√¥ng c√≥ b·ªô l·ªçc
            const snapshot = await questionsCollection
              .orderBy("timestamp", "desc")
              .get();
            allQuestions = snapshot.docs.map((doc) => ({
              id: doc.id, // Quan tr·ªçng: L·∫•y ID ƒë·ªÉ c·∫≠p nh·∫≠t
              ...doc.data(),
            }));
          }

          // N·∫øu c√≥ phi√™n ƒëang ho·∫°t ƒë·ªông, kh√¥ng hi·ªÉn th·ªã c√†i ƒë·∫∑t
          if (
            document.getElementById("quiz-container").style.display === "block"
          ) {
            document.getElementById("quiz-settings").style.display = "none";
            updateFilter(); // Ch·ªâ c·∫ßn c·∫≠p nh·∫≠t b·ªô l·ªçc n·ªÅn
            return;
          }

          const searchInput = document.getElementById("review-search-input");
          const clearSearchBtn = document.getElementById("clear-search-btn");

          // S·ª± ki·ªán khi nh·∫≠p v√†o √¥ t√¨m ki·∫øm
          searchInput.addEventListener("input", () => {
            // Hi·ªÉn th·ªã ho·∫∑c ·∫©n n√∫t 'x'
            clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
            updateFilter();
          });

          // S·ª± ki·ªán khi nh·∫•n n√∫t 'x'
          clearSearchBtn.addEventListener('click', () => {
            searchInput.value = ''; // X√≥a n·ªôi dung
            clearSearchBtn.style.display = 'none'; // ·∫®n n√∫t 'x'
            updateFilter(); // C·∫≠p nh·∫≠t l·∫°i b·ªô l·ªçc
            searchInput.focus(); // Tr·∫£ con tr·ªè v·ªÅ √¥ input
          });

          // G·∫Øn s·ª± ki·ªán cho c√°c b·ªô l·ªçc
          document
            .getElementById("exclude-mastered-questions")
            .addEventListener("change", updateFilter);
          document
            .getElementById("tag-filter")
            .addEventListener("change", updateFilter);
          document
            .getElementById("favorites-only")
            .addEventListener("change", updateFilter);
          // G·∫Øn s·ª± ki·ªán cho c√°c checkbox b·ªô l·ªçc m·ªõi
          document.getElementById('enable-keyword-filter').addEventListener('change', (e) => {
              document.getElementById('review-search-input').disabled = !e.target.checked;
              updateFilter();
          });
          document.getElementById('enable-tag-filter').addEventListener('change', (e) => {
              document.getElementById('tag-filter').disabled = !e.target.checked;
              updateFilter();
          });
          document.getElementById('enable-passage-timer').addEventListener('change', (e) => {
              document.getElementById('passage-timer-minutes').disabled = !e.target.checked;
          });
          document.getElementById('enable-single-timer').addEventListener('change', (e) => {
              document.getElementById('single-timer-seconds').disabled = !e.target.checked;
          });


          // Kh·ªüi t·∫°o hi·ªÉn th·ªã n√∫t x√≥a
          clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';


          // C·∫≠p nh·∫≠t b·ªô l·ªçc l·∫ßn ƒë·∫ßu
          updateFilter();

          // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô l·ªçc t·ª´ trang th·ªëng k√™, ·∫©n ph·∫ßn c√†i ƒë·∫∑t
          if (isFilteredMode) {
            document.getElementById("quiz-settings").style.display = "none";
            document.getElementById("max-questions").value =
              allQuestions.length; // T·ª± ƒë·ªông l√†m t·∫•t c·∫£ c√¢u h·ªèi ƒë√£ l·ªçc
          }

          if (allQuestions.length === 0) {
            document.getElementById("quiz-container").style.display = "block";
            document.getElementById("quiz").innerHTML =
              "<p>Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ √¥n t·∫≠p.</p>";
            document.getElementById("start-btn").style.display = "none";
            document.getElementById("quiz-settings").style.display = "none";
          }
        } catch (error) {
          console.error("L·ªói khi t·∫£i c√¢u h·ªèi:", error);
          document.getElementById("quiz-container").style.display = "block";
          document.getElementById("quiz").innerHTML =
            "<p style='color:red;'>L·ªói t·∫£i d·ªØ li·ªáu. Ki·ªÉm tra k·∫øt n·ªëi v√† console.</p>";
          document.getElementById("start-btn").style.display = "none";
        }
      }

      // H√†m l·ªçc c√¢u h·ªèi v√† c·∫≠p nh·∫≠t UI
      function updateFilter() {
        // Populate tag filter first if it's empty
        const tagFilter = document.getElementById("tag-filter");
        if (tagFilter.options.length <= 1) {
          const tags = new Set(allQuestions.map((q) => q.tag).filter(Boolean));
          tags.forEach((tag) => {
            const option = document.createElement("option");
            option.value = tag;
            option.textContent = tag;
            tagFilter.appendChild(option);
          });
        }

        const enableKeywordFilter = document.getElementById('enable-keyword-filter').checked;
        const enableTagFilter = document.getElementById('enable-tag-filter').checked;

        const selectedTag = tagFilter.value;
        const searchTerm = document
          .getElementById("review-search-input")
          .value.toLowerCase();
        const excludeMastered = document.getElementById(
          "exclude-mastered-questions"
        ).checked;
        const favoritesOnly = document.getElementById(
          "favorites-only"
        ).checked;
        const totalCountSpan = document.getElementById("total-questions-count");
        const maxQuestionsInput = document.getElementById("max-questions");
        const filteredCountSpan = document.getElementById(
          "filtered-questions-count"
        );

        let tempFiltered = [...allQuestions];

        // 0. L·ªçc theo G·∫Øn sao
        if (favoritesOnly) {
          tempFiltered = tempFiltered.filter((q) => q.isFavorite);
        }

        // 1. L·ªçc theo Tag
        if (enableTagFilter && selectedTag) {
          tempFiltered = tempFiltered.filter((q) => q.tag === selectedTag);
        }
        // 2. L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm
        if (enableKeywordFilter && searchTerm) {
          tempFiltered = tempFiltered.filter((q) => {
            if (!q) return false;
            let contentToSearch = "";
            if (q.type === "passage") {
              // T√¨m trong c·∫£ b√†i ƒë·ªçc, c√¢u h·ªèi con, ƒë√°p √°n con, gi·∫£i th√≠ch con
              contentToSearch = q.passage || "";
              if (q.sub_questions) {
                q.sub_questions.forEach((subQ) => {
                  contentToSearch += " " + (subQ.question || "");
                  contentToSearch +=
                    " " + (subQ.choices ? subQ.choices.join(" ") : "");
                  contentToSearch += " " + (subQ.explanation || "");
                });
              }
            } else {
              // T√¨m trong c√¢u h·ªèi ƒë∆°n, ƒë√°p √°n, gi·∫£i th√≠ch
              contentToSearch = q.question || "";
              contentToSearch += " " + (q.choices ? q.choices.join(" ") : "");
              contentToSearch += " " + (q.explanation || "");
            }
            return contentToSearch
              .replace(/<[^>]+>/g, "")
              .toLowerCase()
              .includes(searchTerm);
          });
        }
        // 3. L·ªçc c√°c c√¢u ƒë√£ n·∫Øm r√µ
        if (excludeMastered) {
          tempFiltered = tempFiltered.filter((q) => {
            const attempts = q.attempts || 0;
            const correctAttempts = q.correctAttempts || 0;
            if (attempts <= 5) return true; // Gi·ªØ l·∫°i v√¨ ch∆∞a l√†m ƒë·ªß 5 l·∫ßn
            // ƒê·ªëi v·ªõi b√†i ƒë·ªçc, t·ª∑ l·ªá ƒë√∫ng ƒë∆∞·ª£c t√≠nh tr√™n t·ªïng s·ªë c√¢u h·ªèi con ƒë√£ l√†m
            const totalPossibleAttempts =
              q.type === "passage"
                ? attempts * (q.totalSubQuestions || 1)
                : attempts;
            if (totalPossibleAttempts === 0) return true; // Gi·ªØ l·∫°i n·∫øu c√≥ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
            const successRate = correctAttempts / totalPossibleAttempts;
            return successRate <= 0.75; // Gi·ªØ l·∫°i n·∫øu t·ª∑ l·ªá ƒë√∫ng <= 75%
          });
        }

        filteredQuestions = tempFiltered;
        filteredCountSpan.innerHTML = `üîç T√¨m th·∫•y <b>${filteredQuestions.length}</b> c√¢u.`;
        totalCountSpan.textContent = filteredQuestions.length;
        maxQuestionsInput.max = filteredQuestions.length;
      }

      function shuffle(arr) {
        return arr.sort(() => Math.random() - 0.5);
      }

      function stopTimer() {
        clearInterval(timerInterval);
      }

      function show() {
        // Th√™m ki·ªÉm tra an to√†n ·ªü ƒë·∫ßu h√†m
        if (quizQuestions.length === 0 || index >= quizQuestions.length) {
          document.getElementById("quiz-container").style.display = "block";
          document.getElementById("quiz").innerHTML =
            "<p>Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ √¥n t·∫≠p.</p>";
          document.getElementById("next-btn").style.display = "none";
          return;
        }

        // D·ª´ng timer c≈© v√† b·∫Øt ƒë·∫ßu timer m·ªõi
        stopTimer();

        const passageContentDiv = document.getElementById("passage-content");
        passageContentDiv.style.display = "none";
        passageContentDiv.innerHTML = "";

        const currentQuestion = quizQuestions[index]; // ƒê√¢y l√† c√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c l√†m ph·∫≥ng

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Quay l·∫°i/Ti·∫øp theo
        document.getElementById("prev-btn").disabled = index === 0;
        document.getElementById("next-btn").disabled =
          index === quizQuestions.length - 1;
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ƒê√°nh d·∫•u
        document
          .getElementById("flag-btn")
          .classList.toggle("active", !!currentQuestion.isFlagged);
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t G·∫Øn sao
        updateFavoriteButtonsUI(!!currentQuestion.isFavorite);

        updateStatusBar();
        // N·∫øu ƒë√£ tr·∫£ l·ªùi, hi·ªÉn th·ªã l·∫°i tr·∫°ng th√°i c≈©
        const isAnswered = currentQuestion.hasOwnProperty("userAnswerIndex");

        // X√≥a n√∫t s·ª≠a c≈©
        document.getElementById("edit-button-container").innerHTML = "";

        if (currentQuestion.isSubQuestion) {
          // Hi·ªÉn th·ªã b√†i ƒë·ªçc
          passageContentDiv.style.display = "block";
          passageContentDiv.innerHTML = currentQuestion.annotatedPassageContent || currentQuestion.passageContent;
        }

        const quizDiv = document.getElementById("quiz");

        // --- Logic x√°o tr·ªôn ƒë√°p √°n (ch·ªâ x√°o tr·ªôn l·∫ßn ƒë·∫ßu) ---
        if (!currentQuestion.shuffledChoices) {
          currentQuestion.shuffledChoices = shuffle([
            ...currentQuestion.choices,
          ]);
        }
        const newCorrectIndex = currentQuestion.shuffledChoices.indexOf(
          currentQuestion.choices[currentQuestion.correct]
        );
        // --- K·∫øt th√∫c logic x√°o tr·ªôn ---

        const questionTitle = document.createElement("h3");
        const tagDisplay = currentQuestion.tag
          ? `<span style="font-size: 0.7em; color: #888; font-weight: normal; background-color: var(--explanation-bg); padding: 2px 6px; border-radius: 4px; margin-left: 8px;">${currentQuestion.tag}</span>`
          : "";
        questionTitle.innerHTML = `C√¢u ${index + 1}/${
          quizQuestions.length
        }: ${currentQuestion.annotatedQuestion || currentQuestion.question}${tagDisplay}`;
        questionTitle.style.paddingRight = '100px'; // T·∫°o kh√¥ng gian cho timer
        quizDiv.innerHTML = "";
        quizDiv.appendChild(questionTitle);

        currentQuestion.shuffledChoices.forEach((choiceText, i) => {
          const btn = document.createElement("div");
          btn.className = "choice";
          btn.textContent = `${i + 1}) ${choiceText}`;
          if (!isAnswered) {
            btn.onclick = () => check(i, newCorrectIndex, btn);
          }
          quizDiv.appendChild(btn);
        });

        if (isAnswered) {
          const allChoices = quizDiv.querySelectorAll(".choice");
          if (currentQuestion.userAnswerIndex === newCorrectIndex) {
            allChoices[currentQuestion.userAnswerIndex].classList.add(
              "correct"
            );
          } else {
            allChoices[currentQuestion.userAnswerIndex].classList.add("wrong");
            allChoices[newCorrectIndex].classList.add("correct");
          }
          // Hi·ªÉn th·ªã l·∫°i gi·∫£i th√≠ch n·∫øu c√≥
          if (currentQuestion.explanation) {
            const explanationDiv = document.createElement("div");
            explanationDiv.className = "explanation"; // S·ª≠ d·ª•ng class chung
            explanationDiv.innerHTML = `<b>üí° Gi·∫£i th√≠ch:</b> ${currentQuestion.explanation.replace(
              /\n/g,
              "<br>"
            )}`;
            quizDiv.appendChild(explanationDiv);
          }
          // Hi·ªÉn th·ªã n√∫t s·ª≠a n·∫øu ƒë√£ tr·∫£ l·ªùi
          const editButtonContainer = document.getElementById(
            "edit-button-container"
          );
          const editButton = document.createElement("button"); // Kh√¥i ph·ª•c n√∫t s·ª≠a
        editButton.innerHTML = "‚úèÔ∏è S·ª≠a c√¢u h·ªèi n√†y";
        editButton.onclick = () => openEditModal(index); // Pass the current index
          editButtonContainer.appendChild(editButton);
          // ·∫®n ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c v√¨ c√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi
          document.getElementById("timer-display").style.display = "none";
        } else {
          // B·∫Øt ƒë·∫ßu timer cho c√¢u h·ªèi hi·ªán t·∫°i ch·ªâ khi n√≥ ch∆∞a ƒë∆∞·ª£c tr·∫£ l·ªùi
          startTimerForCurrentQuestion();
        }
      }

      function check(i, correct, btn) {
        const currentQuestion = quizQuestions[index];
        const questionId = currentQuestion.id; // ID c·ªßa c√¢u h·ªèi ƒë∆°n ho·∫∑c ID c·ªßa b√†i ƒë·ªçc cha

        // L∆∞u tr·∫°ng th√°i tr·∫£ l·ªùi
        stopTimer(); // D·ª´ng ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
        const timeTaken = (Date.now() - questionStartTime) / 1000; // t√≠nh b·∫±ng gi√¢y

        // Ch·ªâ l∆∞u th·ªùi gian cho c√¢u h·ªèi ƒë∆°n
        if (!currentQuestion.isSubQuestion) {
            singleQuestionTimes.push(timeTaken);
            currentQuestion.timeTaken = timeTaken; // L∆∞u v√†o ƒë·ªëi t∆∞·ª£ng c√¢u h·ªèi
        }
        currentQuestion.userAnswerIndex = i;
        const wasCorrect = i === correct;
        currentQuestion.isCorrect = wasCorrect;

        if (!questionId) {
          console.error("Kh√¥ng t√¨m th·∫•y ID c·ªßa c√¢u h·ªèi!");
        }

        const all = document.querySelectorAll(".choice");
        all.forEach((x) => (x.onclick = null));

        btn.classList.add("selected");
        // C·∫≠p nh·∫≠t s·ªë l·∫ßn l√†m
        const updateData = {};

        // Ch·ªâ tƒÉng 'attempts' m·ªôt l·∫ßn cho m·ªói b√†i ƒë·ªçc trong m·ªôt phi√™n quiz
        if (!currentQuestion.attemptCounted) {
          updateData.attempts = firebase.firestore.FieldValue.increment(1);
          // ƒê√°nh d·∫•u l√† ƒë√£ ƒë·∫øm l·∫ßn l√†m cho c√¢u h·ªèi/b√†i ƒë·ªçc n√†y trong phi√™n
          markAttemptAsCounted(currentQuestion.id);
        }

        if (wasCorrect) {
          btn.classList.add("correct");
          correctCount++;
          updateData.correctAttempts =
            firebase.firestore.FieldValue.increment(1);
        } else {
          btn.classList.add("wrong");
          all[correct].classList.add("correct");
          incorrectCount++;
        }
        updateScore();

        // C·∫≠p nh·∫≠t m√†u cho √¥ tr·∫°ng th√°i
        updateStatusBar();

        // Hi·ªÉn th·ªã gi·∫£i th√≠ch n·∫øu c√≥
        if (currentQuestion.explanation) {
          const explanationDiv = document.createElement("div");
          explanationDiv.className = "explanation"; // S·ª≠ d·ª•ng class chung
          explanationDiv.innerHTML = `<b>üí° Gi·∫£i th√≠ch:</b> ${currentQuestion.explanation.replace(
            /\n/g,
            "<br>"
          )}`;
          const quizDiv = document.getElementById("quiz");
          quizDiv.appendChild(explanationDiv);
        }

        // Hi·ªÉn th·ªã n√∫t s·ª≠a c√¢u h·ªèi
        const editButtonContainer = document.getElementById(
          "edit-button-container"
        );
        const editButton = document.createElement("button"); // Kh√¥i ph·ª•c n√∫t s·ª≠a
        editButton.innerHTML = "‚úèÔ∏è S·ª≠a c√¢u h·ªèi n√†y";
        editButton.onclick = () => openEditModal(); // G·ªçi h√†m ƒë√∫ng c√°ch, kh√¥ng truy·ªÅn ƒë·ªëi s·ªë s·ª± ki·ªán
        editButtonContainer.appendChild(editButton);

        // G·ª≠i c·∫≠p nh·∫≠t l√™n Firestore m·ªôt c√°ch b·∫•t ƒë·ªìng b·ªô
        if (questionId) {
          questionsCollection
            .doc(questionId)
            .update(updateData)
            .catch((err) => console.error("L·ªói c·∫≠p nh·∫≠t th·ªëng k√™:", err));
        }
      }

      function toggleFlag() {
        const currentQuestion = quizQuestions[index];
        currentQuestion.isFlagged = !currentQuestion.isFlagged;
        document
          .getElementById("flag-btn")
          .classList.toggle("active", currentQuestion.isFlagged);
        updateStatusBar();
        saveQuizSession(); // L∆∞u l·∫°i tr·∫°ng th√°i ƒë√°nh d·∫•u
      }

      async function toggleFavorite() {
        const currentQuestion = quizQuestions[index];
        if (!currentQuestion || !currentQuestion.id) return;

        const newFavoriteStatus = !currentQuestion.isFavorite;
        currentQuestion.isFavorite = newFavoriteStatus;

        // C·∫≠p nh·∫≠t trong m·∫£ng allQuestions ƒë·ªÉ b·ªô l·ªçc ho·∫°t ƒë·ªông ƒë√∫ng
        const originalQuestion = allQuestions.find(q => q.id === currentQuestion.id);
        if (originalQuestion) {
            originalQuestion.isFavorite = newFavoriteStatus;
        }

        // C·∫≠p nh·∫≠t UI cho c·∫£ hai n√∫t
        updateFavoriteButtonsUI(newFavoriteStatus);

        saveQuizSession(); // L∆∞u l·∫°i tr·∫°ng th√°i m·ªõi

        try {
            await questionsCollection.doc(currentQuestion.id).update({
                isFavorite: newFavoriteStatus
            });
        } catch (error) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i y√™u th√≠ch:", error);
        }
      }

      // H√†m helper ƒë·ªÉ c·∫≠p nh·∫≠t UI cho c√°c n√∫t G·∫Øn sao
      function updateFavoriteButtonsUI(isFavorite) {
          const favBtnDesktop = document.getElementById("favorite-btn");
          const favBtnMobile = document.getElementById("favorite-btn-menu");
          if (favBtnDesktop) favBtnDesktop.classList.toggle("active", isFavorite);
          if (favBtnMobile) favBtnMobile.classList.toggle("active", isFavorite);
      }

      function markAttemptAsCounted(id) {
        quizQuestions.forEach((q) => {
          if (q.id === id) q.attemptCounted = true;
        });
      }

      function next() {
        if (index < quizQuestions.length - 1) {
          index++;
          show();
        } else {
          // Ki·ªÉm tra xem c√≤n c√¢u ch∆∞a tr·∫£ l·ªùi kh√¥ng
          const firstUnanswered = quizQuestions.findIndex(
            (q) => !q.hasOwnProperty("userAnswerIndex")
          );
          if (firstUnanswered !== -1) {
            if (
              confirm(
                "V·∫´n c√≤n c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ mu·ªën ho√†n th√†nh b√†i l√†m kh√¥ng?"
              )
            ) {
              showFinalResult();
            } else {
              index = firstUnanswered;
              show();
            }
          } else {
            showFinalResult();
          }
        }
      }

      function showFinalResult() {
        // X√≥a phi√™n l√†m b√†i v√¨ ƒë√£ ho√†n th√†nh
        sessionStorage.removeItem("quizSession");

        document.getElementById("quiz-container").style.display = "none";
        document.getElementById("final-result").style.display = "block";
        document.getElementById("next-btn").style.display = "none";
        document.getElementById("prev-btn").style.display = "none";
        document.getElementById("submit-btn").style.display = "none";
        document.getElementById("unanswered-btn").style.display = "none";
        document.getElementById("exit-btn").style.display = "inline-block";
        document.getElementById("button-bar").style.display = "block";
        document.getElementById("start-btn").style.display = "inline-block";
        document.getElementById("start-btn").textContent = "üé≤ L√†m l·∫°i";

        document.getElementById("timer-display").style.display = "none";
        const total = quizQuestions.length;
        const percentage =
          total > 0 ? ((correctCount / total) * 100).toFixed(1) : 0;

        document.getElementById("final-score").innerHTML = `
          B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng <b>${correctCount}/${total}</b> c√¢u h·ªèi (${percentage}%).
        `;

        // T√≠nh v√† hi·ªÉn th·ªã th·ªùi gian trung b√¨nh
        if (singleQuestionTimes.length > 0) {
            const totalTime = singleQuestionTimes.reduce((acc, time) => acc + time, 0);
            const averageTime = (totalTime / singleQuestionTimes.length).toFixed(1);
            document.getElementById("average-time-stat").textContent = `‚è±Ô∏è Th·ªùi gian trung b√¨nh cho 1 c√¢u h·ªèi ƒë∆°n: ${averageTime} gi√¢y.`;
        } else {
            document.getElementById("average-time-stat").textContent = "";
        }

        // L·ªçc c√¢u h·ªèi d·ª±a tr√™n checkbox "·∫®n c√°c c√¢u tr·∫£ l·ªùi ƒë√∫ng"
        const hideCorrect = document.getElementById(
          "hide-correct-answers"
        ).checked;
        let questionsToShow = quizQuestions;

        if (hideCorrect) {
          questionsToShow = quizQuestions.filter((q) => {
            if (!q.hasOwnProperty("userAnswerIndex")) return true; // Lu√¥n hi·ªÉn th·ªã c√¢u ch∆∞a tr·∫£ l·ªùi
            const correctChoiceText = q.choices[q.correct];
            const userChoiceText = q.shuffledChoices[q.userAnswerIndex];
            return userChoiceText !== correctChoiceText;
          });
        }
        // Hi·ªÉn th·ªã danh s√°ch c√¢u tr·∫£ l·ªùi
        const listDiv = document.getElementById("final-answers-list");
        listDiv.innerHTML = questionsToShow
          .map((q) => {
            const originalIndex = quizQuestions.indexOf(q); // L·∫•y index g·ªëc ƒë·ªÉ h√†m showReviewDetail ho·∫°t ƒë·ªông ƒë√∫ng
            const correctChoiceText = q.choices[q.correct];
            // NgƒÉn ch·∫∑n s·ª± ki·ªán click lan t·ªèa t·ª´ n√∫t S·ª≠a
            const editButtonHTML = `
              <button class="btn-edit-final" onclick="event.stopPropagation(); openEditModal(${originalIndex})">
                ‚úèÔ∏è S·ª≠a
              </button>
            `;
            // S·ª≠a ƒë·ªïi: ƒê·∫£m b·∫£o q.explanation ƒë∆∞·ª£c ki·ªÉm tra v√† hi·ªÉn th·ªã
            const explanationHTML = q.explanation ?
              `<div class="explanation" style="margin-top: 8px;"><b>üí° Gi·∫£i th√≠ch:</b> ${q.explanation.replace(/\n/g, "<br>")}</div>` : '';
            const flagIndicator = q.isFlagged
              ? ' <span style="color: #ff9800; font-weight: bold;">üö©</span>'
              : "";
            const userChoiceText = q.hasOwnProperty("userAnswerIndex")
              ? q.shuffledChoices[q.userAnswerIndex]
              : "<i>Ch∆∞a tr·∫£ l·ªùi</i>";
            const isCorrect = userChoiceText === correctChoiceText;

            let userAnswerHTML = `<b>B·∫°n ch·ªçn:</b> ${userChoiceText}`;
            if (!isCorrect) {
              userAnswerHTML = `<span style="color: red;">${userAnswerHTML}</span>`;
            }

            return `
                    <div class="final-question-item" onclick='showReviewDetail(${originalIndex})'>
                        <div class="final-question-item-header">
                            <p style="flex-grow: 1;">${q.question}${flagIndicator}</p>
                            ${editButtonHTML}
                        </div>
                        <p>${userAnswerHTML}</p>
                        <p style="color: green;"><b>ƒê√°p √°n ƒë√∫ng:</b> ${correctChoiceText}</p>
                        ${explanationHTML}
                    </div>
                `;
          })
          .join("");
      }

      function prev() {
        if (index > 0) {
          index--;
          show();
        }
      }

      function showReviewDetail(questionIndex) {
        const q = quizQuestions[questionIndex];
        const modal = document.getElementById("review-detail-modal");
        const passageDiv = document.getElementById("review-passage-content");
        const detailDiv = document.getElementById("review-question-detail");

        if (q.isSubQuestion) {
          passageDiv.innerHTML = q.passageContent;
          passageDiv.style.display = "block";
        } else {
          passageDiv.style.display = "none";
        }

        let choicesHTML = q.shuffledChoices
          .map((choice, i) => {
            let className = "choice";
            if (q.hasOwnProperty("userAnswerIndex")) {
              if (
                i === q.userAnswerIndex &&
                q.userAnswerIndex !==
                  q.shuffledChoices.indexOf(q.choices[q.correct])
              ) {
                className += " wrong";
              }
            }
            if (choice === q.choices[q.correct]) {
              className += " correct";
            }
            return `<div class="${className}">${i + 1}) ${choice}</div>`;
          })
          .join("");

        const explanationHTML = q.explanation
          ? `<div class="explanation"><b>üí° Gi·∫£i th√≠ch:</b> ${q.explanation}</div>`
          : ""; // S·ª≠ d·ª•ng class chung

        detailDiv.innerHTML = `<h3>${q.question}</h3>${choicesHTML}${explanationHTML}`;
        modal.style.display = "flex";
      }

      function closeReviewDetailModal() {
        document.getElementById("review-detail-modal").style.display = "none";
      }

      function goToQuestion(newIndex) {
        if (newIndex >= 0 && newIndex < quizQuestions.length) {
          index = newIndex;
          saveQuizSession();
          show();
        }
      }

      function openEditModal(questionIndex) {
        // S·ª≠ d·ª•ng questionIndex ƒë∆∞·ª£c truy·ªÅn v√†o, ho·∫∑c index to√†n c·ª•c n·∫øu kh√¥ng c√≥
        const q = quizQuestions[questionIndex ?? index];
        // Th√™m ki·ªÉm tra an to√†n ƒë·ªÉ ƒë·∫£m b·∫£o `q` kh√¥ng ph·∫£i l√† undefined
        if (!q) {
          alert("L·ªói: Kh√¥ng th·ªÉ t√¨m th·∫•y c√¢u h·ªèi ƒë·ªÉ s·ª≠a. Vui l√≤ng th·ª≠ l·∫°i.");
          return;
        }

        if (q.isSubQuestion) {
          // T√¨m b√†i ƒë·ªçc g·ªëc trong `allQuestions`
          const originalPassage = allQuestions.find((item) => item.id === q.id);
          if (!originalPassage) {
            return alert("L·ªói: Kh√¥ng t√¨m th·∫•y b√†i ƒë·ªçc g·ªëc.");
          }
          // ƒêi·ªÅn d·ªØ li·ªáu v√†o modal s·ª≠a b√†i ƒë·ªçc
          document.getElementById("passageEditText").innerHTML =
            originalPassage.passage;
          document.getElementById("passageEditSubQuestions").innerHTML =
            formatSubQuestionsForEditing(originalPassage.sub_questions);
          // Hi·ªÉn th·ªã modal
          document.getElementById("editPassageModal").classList.add("show");
        } else {
          // X·ª≠ l√Ω cho c√¢u h·ªèi ƒë∆°n nh∆∞ c≈©
          document.getElementById("editQ").innerHTML = q.question;
          document.getElementById("editC1").value = q.choices[0] || "";
          document.getElementById("editC2").value = q.choices[1] || "";
          document.getElementById("editC3").value = q.choices[2] || "";
          document.getElementById("editC4").value = q.choices[3] || "";
          document.getElementById("editCorrect").value = q.correct + 1;
          document.getElementById("editExplanation").innerHTML =
            q.explanation || "";
          // Hi·ªÉn th·ªã modal
          document.getElementById("editQuestionModal").classList.add("show");
        }
      }

      function closeEditModal() {
        document.getElementById("editQuestionModal").classList.remove("show");
      }

      async function saveEdit() {
        // X√≥a c√°c highlight c·ªßa ch·∫ø ƒë·ªô "Ch·ªçn nhi·ªÅu" tr∆∞·ªõc khi l∆∞u
        removeHighlights('editQ');
        removeHighlights('editExplanation');

        const q = quizQuestions[index];
        if (!q || !q.id) return alert("L·ªói: Kh√¥ng t√¨m th·∫•y ID c√¢u h·ªèi.");

        const updatedData = {
          question: document.getElementById("editQ").innerHTML,
          choices: [
            document.getElementById("editC1").value,
            document.getElementById("editC2").value,
            document.getElementById("editC3").value,
            document.getElementById("editC4").value,
          ],
          correct: parseInt(document.getElementById("editCorrect").value) - 1,
          explanation: document
            .getElementById("editExplanation")
            .innerHTML.trim(),
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        };

        await questionsCollection.doc(q.id).update(updatedData);
        alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t c√¢u h·ªèi th√†nh c√¥ng!");
        closeEditModal();
        quizQuestions[index] = { ...quizQuestions[index], ...updatedData }; // C·∫≠p nh·∫≠t l·∫°i c√¢u h·ªèi trong phi√™n
        await loadAllQuestions(); // T·∫£i l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu nh·∫•t qu√°n
      }

      // --- C√°c h√†m m·ªõi ƒë·ªÉ s·ª≠a b√†i ƒë·ªçc ---
      function closeEditPassageModal() {
        document.getElementById("editPassageModal").classList.remove("show");
      }

      // H√†m helper ƒë·ªÉ ƒë·ªãnh d·∫°ng c√°c c√¢u h·ªèi con th√†nh text ƒë·ªÉ ch·ªânh s·ª≠a
      function formatSubQuestionsForEditing(subQuestions) {
        if (!subQuestions) return "";
        return subQuestions
          .map((sq, index) => {
            const choicesStr = sq.choices
              .map((choice, cIndex) => `${cIndex + 1}) ${choice}`)
              .join("\n");
            const correctStr = `Ê≠£Ëß£: ${sq.correct + 1}`;
            const explanationStr = sq.explanation
              ? `\nGi·∫£i th√≠ch: ${sq.explanation}`
              : "";
            return `${index + 1}. ${
              sq.question
            }\n${choicesStr}\n${correctStr}${explanationStr}`;
          })
          .join("\n\n"); // Th√™m d√≤ng tr·ªëng gi·ªØa c√°c c√¢u h·ªèi
      }

      async function savePassageEdit() {
        // X√≥a c√°c highlight c·ªßa ch·∫ø ƒë·ªô "Ch·ªçn nhi·ªÅu" tr∆∞·ªõc khi l∆∞u
        removeHighlights('passageEditText');
        removeHighlights('passageEditSubQuestions');

        const currentSubQuestion = quizQuestions[index];
        if (!currentSubQuestion.isSubQuestion) return;

        const passageId = currentSubQuestion.id;
        const passageHTML = document
          .getElementById("passageEditText")
          .innerHTML.trim();
        const subQuestionsHTML = document
          .getElementById("passageEditSubQuestions")
          .innerHTML.trim();

        if (!passageHTML || !subQuestionsHTML) {
          return alert("N·ªôi dung b√†i ƒë·ªçc v√† c√¢u h·ªèi kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        }

        // T√°i s·ª≠ d·ª•ng h√†m ph√¢n t√≠ch t·ª´ trang input (c·∫ßn ƒë·∫£m b·∫£o n√≥ t·ªìn t·∫°i ho·∫∑c copy qua)
        // Gi·∫£ s·ª≠ ƒë√£ c√≥ h√†m parseQuestionsFromHTML
        const sub_questions = parseQuestionsFromHTML(subQuestionsHTML);
        if (sub_questions.length === 0) {
          return alert(
            "Kh√¥ng ph√¢n t√≠ch ƒë∆∞·ª£c c√¢u h·ªèi con n√†o. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng."
          );
        }

        const updatedData = {
          passage: passageHTML,
          sub_questions: sub_questions,
          totalSubQuestions: sub_questions.length,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        };

        try {
          await questionsCollection.doc(passageId).update(updatedData);
          alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t b√†i ƒë·ªçc th√†nh c√¥ng!");
          closeEditPassageModal();

          // --- C·∫≠p nh·∫≠t d·ªØ li·ªáu t·∫°i ch·ªó thay v√¨ reload trang ---
          // 1. C·∫≠p nh·∫≠t b√†i ƒë·ªçc g·ªëc trong m·∫£ng `allQuestions`
          const originalPassageIndex = allQuestions.findIndex(q => q.id === passageId);
          if (originalPassageIndex > -1) {
              // L·∫•y d·ªØ li·ªáu c≈© v√† h·ª£p nh·∫•t v·ªõi d·ªØ li·ªáu m·ªõi
              allQuestions[originalPassageIndex] = { ...allQuestions[originalPassageIndex], ...updatedData };
          }

          // 2. C·∫≠p nh·∫≠t l·∫°i t·∫•t c·∫£ c√°c c√¢u h·ªèi con c·ªßa b√†i ƒë·ªçc n√†y trong phi√™n quiz hi·ªán t·∫°i
          quizQuestions.forEach((q, i) => {
              if (q.id === passageId) {
                  // T√¨m c√¢u h·ªèi con t∆∞∆°ng ·ª©ng trong d·ªØ li·ªáu m·ªõi
                  const newSubQuestion = sub_questions.find(sub => sub.question === q.question);
                  if (newSubQuestion) {
                      quizQuestions[i] = { ...q, ...newSubQuestion };
                  }
              }
          });

          // 3. Hi·ªÉn th·ªã l·∫°i c√¢u h·ªèi hi·ªán t·∫°i v·ªõi d·ªØ li·ªáu ƒë√£ c·∫≠p nh·∫≠t
          show();
        } catch (error) {
          console.error("L·ªói khi l∆∞u b√†i ƒë·ªçc:", error);
          alert("L·ªói khi l∆∞u b√†i ƒë·ªçc. Ki·ªÉm tra console.");
        }
      }

      function formatEdit(cmd, targetId) {
        const targetDiv = document.getElementById(targetId);
        const highlighted = targetDiv.querySelectorAll(".multi-select-highlight");

        if (isMultiSelectMode && highlighted.length > 0) {
            document.execCommand("styleWithCSS", false, false);
            highlighted.forEach((span) => {
                const range = document.createRange();
                range.selectNodeContents(span);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                document.execCommand(cmd, false, null);
                selection.removeAllRanges();
            });
            removeHighlights(targetId); // X√≥a highlight sau khi √°p d·ª•ng
        } else {
            document.execCommand(cmd, false, null);
        }
        targetDiv.focus();
      }

      // --- Ch·ª©c nƒÉng Ch·ªçn nhi·ªÅu ---
      function toggleMultiSelectMode(btn, targetId) {
        const isActive = btn.classList.contains("active");
        // T·∫Øt t·∫•t c·∫£ c√°c n√∫t 'Ch·ªçn nhi·ªÅu' ƒëang active kh√°c
        document
          .querySelectorAll('.active[onclick*="toggleMultiSelectMode"]')
          .forEach((b) => {
            if (b !== btn) {
              b.classList.remove("active");
            }
          });

        // B·∫≠t/t·∫Øt n√∫t hi·ªán t·∫°i
        isMultiSelectMode = !isActive;
        btn.classList.toggle("active", isMultiSelectMode);

        if (!isMultiSelectMode) {
          removeHighlights(targetId);
        }
      }

      function handleMouseUp(e) {
        const targetDiv = e.currentTarget;
        if (!isMultiSelectMode) return;

        const selection = window.getSelection();
        if (selection.isCollapsed || !selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        if (!targetDiv.contains(range.commonAncestorContainer)) return;

        const span = document.createElement("span");
        span.className = "multi-select-highlight"; // C·∫ßn th√™m class CSS n√†y
        try {
          range.surroundContents(span);
        } catch (ex) {
          // B·ªè qua l·ªói n·∫øu kh√¥ng th·ªÉ bao quanh (v√≠ d·ª•: ch·ªçn qua nhi·ªÅu block)
        }
        selection.removeAllRanges();
      }

      function removeHighlights(targetId = null) {
        const selector = targetId ? `#${targetId} .multi-select-highlight` : '.multi-select-highlight';
        const highlighted = document.querySelectorAll(selector);
        highlighted.forEach((span) => {
          span.replaceWith(...span.childNodes);
        });
        const targetDiv = document.getElementById(targetId);
        if (targetDiv) {
            targetDiv.normalize(); // G·ªôp c√°c text node li·ªÅn k·ªÅ
        }
      }

            // --- More Options Menu Logic ---
      function toggleMoreOptionsMenu(event) {
          event.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan ra ngo√†i
          const menu = document.getElementById('more-options-menu');
          menu.classList.toggle('active');
      }

      // ƒê√≥ng menu khi click ra ngo√†i
      window.addEventListener('click', function(event) {
          const menu = document.getElementById('more-options-menu');
          const btn = document.getElementById('more-options-btn');
          if (menu && menu.classList.contains('active')) {
              // Ki·ªÉm tra xem click c√≥ n·∫±m ngo√†i menu v√† ngo√†i n√∫t 3 ch·∫•m kh√¥ng
              if (!menu.contains(event.target) && !btn.contains(event.target)) {
                  menu.classList.remove('active');
              }
          }
      });

      function submitQuiz() {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?")) {
          showFinalResult();
        }
      }

      // H√†m ph√¢n t√≠ch c√¢u h·ªèi t·ª´ HTML (copy t·ª´ index.html)
      function parseQuestionsFromHTML(html) {
        const questions = [];
        if (!html) return questions;

        const normalizedHtml = html
          .replace(/<div>/g, "\n")
          .split(/\n?\s*<br[^>]*>\s*\n?|\n/)
          .join("\n");
        const questionBlocks = normalizedHtml
          .split(/\n\s*(?=(?:„Äê\d+„Äë)|(?:\d+\.\s*)|(?:^\d+\s*$(?!\))))/m)
          .filter((block) => block.trim() !== "");

        questionBlocks.forEach((block) => {
          const lines = block.trim().split("\n");
          if (lines.length === 0) return;

          const questionLines = [];
          let firstChoiceIndex = -1;

          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            const isChoiceStart =
              /^(?:(Ê≠£Ëß£|‰∏çÊ≠£Ëß£)[:Ôºö]?\s*)?\d+\)/.test(line) ||
              /^Ê≠£Ëß£[:Ôºö]?\s*\d+/.test(line) ||
              /^‰∏çÊ≠£Ëß£[:Ôºö]?\s*\d+/.test(line);

            if (isChoiceStart && firstChoiceIndex === -1) {
              firstChoiceIndex = i;
              break;
            }
            questionLines.push(lines[i]);
          }

          let questionHTML = questionLines
            .join("<br>")
            .replace(/^\s*<br>|<br>\s*$/g, "")
            .trim();
          const fillInTheBlankMatch =
            questionHTML.match(/^(?:„Äê(\d+)„Äë|(\d+))$/);

          if (fillInTheBlankMatch) {
            const number = fillInTheBlankMatch[1] || fillInTheBlankMatch[2];
            questionHTML = `(ƒêi·ªÅn v√†o ch·ªó tr·ªëng ${number})`;
          } else {
            questionHTML = questionHTML.replace(/^\d+\.\s*/, "");
          }

          const otherLines =
            firstChoiceIndex !== -1 ? lines.slice(firstChoiceIndex) : [];
          const choices = [];
          let correct = -1;
          let explanation = "";

          otherLines.forEach((line) => {
            const textLine = line.replace(/<[^>]+>/g, "").trim();
            const choiceMatch = textLine.match(
              /^(?:(Ê≠£Ëß£|‰∏çÊ≠£Ëß£)[:Ôºö]?\s*)?(\d+)\)\s*(.*)/
            );
            if (choiceMatch) {
              const keyword = choiceMatch[1];
              const index = parseInt(choiceMatch[2]) - 1;
              const choiceText = choiceMatch[3].trim();
              if (index >= 0) choices[index] = choiceText;
              if (keyword === "Ê≠£Ëß£" && correct === -1) correct = index;
              return;
            }
            const correctLineMatch = textLine.match(/^Ê≠£Ëß£[:Ôºö]?\s*(\d+)/);
            if (correctLineMatch && correct === -1) {
              correct = parseInt(correctLineMatch[1]) - 1;
              return;
            }
            const explanationMatch = textLine.match(
              /^(?:Tham kh·∫£o|Gi·∫£i th√≠ch)[:Ôºö]\s*(.*)/i
            );
            if (explanationMatch) {
              explanation = explanationMatch[1].trim();
              return;
            }
          });

          if (choices.length > 0 && correct !== -1) {
            questions.push({
              question: questionHTML,
              choices,
              correct,
              explanation,
            });
          }
        });
        return questions;
      }

      function submitQuiz() {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?")) {
          showFinalResult();
        }
      }

      function updateScore() {
        document.getElementById("score").innerHTML = `
          <span style="color: green;">‚úîÔ∏è ƒê√∫ng: ${correctCount}</span> | 
          <span style="color: red;">‚ùå Sai: ${incorrectCount}</span>
        `;
      }

      function findNextUnanswered() {
        // T√¨m t·ª´ v·ªã tr√≠ hi·ªán t·∫°i tr·ªü ƒëi
        let nextIndex = quizQuestions.findIndex(
          (q, i) => i > index && !q.hasOwnProperty("userAnswerIndex")
        );
        // N·∫øu kh√¥ng th·∫•y, t√¨m t·ª´ ƒë·∫ßu
        saveQuizSession();
        if (nextIndex === -1) {
          nextIndex = quizQuestions.findIndex(
            (q) => !q.hasOwnProperty("userAnswerIndex")
          );
        }

        if (nextIndex !== -1) {
          index = nextIndex;
          show();
        } else {
          alert("üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ tr·∫£ l·ªùi t·∫•t c·∫£ c√°c c√¢u h·ªèi.");
        }
      }

      function shuffleAndStart() {
        // S·ª≠ d·ª•ng danh s√°ch ƒë√£ l·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu
        const sourceQuestions = filteredQuestions;
        if (sourceQuestions.length === 0) {
          show();
          return;
        }

        const max = parseInt(document.getElementById("max-questions").value);

        // Logic "l√†m ph·∫≥ng" c√¢u h·ªèi TR∆Ø·ªöC KHI x√°o tr·ªôn
        let tempQuizQuestions = [];
        for (const item of sourceQuestions) {
          if (item.type === "passage" && item.sub_questions) {
            // M·ªü r·ªông b√†i ƒë·ªçc th√†nh c√°c c√¢u h·ªèi con ri√™ng bi·ªát
            item.sub_questions.forEach((subQ) => {
              tempQuizQuestions.push({
                id: item.id, // ID c·ªßa b√†i ƒë·ªçc cha ƒë·ªÉ c·∫≠p nh·∫≠t th·ªëng k√™
                isSubQuestion: true, // ƒê√°nh d·∫•u l√† c√¢u h·ªèi con c·ªßa b√†i ƒë·ªçc
                passageContent: item.passage, // N·ªôi dung b√†i ƒë·ªçc
                question: subQ.question,
                isFavorite: item.isFavorite, // Th√™m tr·∫°ng th√°i sao t·ª´ b√†i ƒë·ªçc cha
                tag: item.tag, // Th√™m tag t·ª´ b√†i ƒë·ªçc cha
                choices: subQ.choices,
                correct: subQ.correct,
                explanation: subQ.explanation || "", // Th√™m gi·∫£i th√≠ch
              });
            });
          } else {
            tempQuizQuestions.push(item); // Th√™m c√¢u h·ªèi ƒë∆°n
          }
        }

        // Ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh l√† ng·∫´u nhi√™n
        const isRandomMode = document.getElementById('random-mode').checked;
        let finalQuestionList = tempQuizQuestions;
        if (isRandomMode) {
          finalQuestionList = shuffle(tempQuizQuestions);
        }

        // L·∫•y s·ªë l∆∞·ª£ng c√¢u h·ªèi theo y√™u c·∫ßu
        if (max > 0 && max < finalQuestionList.length) {
          quizQuestions = finalQuestionList.slice(0, max);
        } else {
          quizQuestions = finalQuestionList;
        }
        index = 0;
        correctCount = 0;
        incorrectCount = 0;
        singleQuestionTimes = []; // Reset m·∫£ng th·ªùi gian

        document.getElementById("quiz-settings").style.display = "none";
        document.getElementById("start-btn").style.display = "none";
        document.getElementById("next-btn").style.display = "inline-block";
        document.getElementById("prev-btn").style.display = "inline-block";
        document.getElementById("submit-btn").style.display = "inline-block";
        document.getElementById("unanswered-btn").style.display =
          "inline-block";
        document.getElementById("flag-btn").style.display = "inline-block";
        document.getElementById("favorite-btn").style.display = "inline-block";
        document.getElementById("exit-btn").style.display = "inline-block";
        // Hi·ªÉn th·ªã container c·ªßa n√∫t "Th√™m t√πy ch·ªçn" (CSS s·∫Ω t·ª± x·ª≠ l√Ω vi·ªác ·∫©n/hi·ªán theo k√≠ch th∆∞·ªõc m√†n h√¨nh)
        document.getElementById("timer-display").style.display = "inline-block";
        document.getElementById("more-options-container").style.display = 'inline-flex';
        document.getElementById("quiz-container").style.display = "block";
        document.getElementById("button-bar").style.display = "block";
        document.getElementById("final-result").style.display = "none";

        // T·∫°o thanh tr·∫°ng th√°i
        const statusBar = document.getElementById("question-status-bar");
        statusBar.innerHTML = "";
        quizQuestions.forEach((q, i) => {
          const box = document.createElement("div");
          box.className = "status-box";
          box.id = `status-box-${i}`;
          box.textContent = i + 1;
          box.onclick = () => goToQuestion(i);
          statusBar.appendChild(box);
        });

        show();
        updateScore();
        saveQuizSession();
      }

      function updateStatusBar() {
        quizQuestions.forEach((q, i) => {
          const box = document.getElementById(`status-box-${i}`);
          if (!box) return;
          box.className = "status-box"; // Reset class
          if (q.hasOwnProperty("isCorrect")) {
            box.classList.add(q.isCorrect ? "correct" : "wrong");
          }
          box.classList.toggle("flagged", !!q.isFlagged); // Th√™m/x√≥a class 'flagged'
          if (i === index) {
            box.classList.add("current");
          }
        });
      }

      // --- Ch·ª©c nƒÉng l∆∞u v√† kh√¥i ph·ª•c phi√™n ---
      function saveQuizSession() {
        if (quizQuestions.length > 0) {
          const sessionData = {
            quizQuestions: quizQuestions,
            index: index,
            correctCount: correctCount,
            incorrectCount: incorrectCount,
          };
          sessionStorage.setItem("quizSession", JSON.stringify(sessionData));
        }
      }

      function restoreQuizSession() {
        const savedSession = sessionStorage.getItem("quizSession");
        if (savedSession) {
          const sessionData = JSON.parse(savedSession);
          quizQuestions = sessionData.quizQuestions;
          index = sessionData.index;
          correctCount = sessionData.correctCount;
          incorrectCount = sessionData.incorrectCount;

          // C·∫≠p nh·∫≠t UI ƒë·ªÉ hi·ªÉn th·ªã quiz
          document.getElementById("quiz-settings").style.display = "none";
          document.getElementById("start-btn").style.display = "none";
          document.getElementById("next-btn").style.display = "inline-block";
          document.getElementById("prev-btn").style.display = "inline-block";
          document.getElementById("submit-btn").style.display = "inline-block";
          document.getElementById("unanswered-btn").style.display =
            "inline-block";
          document.getElementById("favorite-btn").style.display = "inline-block";
          document.getElementById("flag-btn").style.display = "inline-block";
          document.getElementById("more-options-container").style.display = 'inline-flex';
          document.getElementById("exit-btn").style.display = "inline-block";
          document.getElementById("quiz-container").style.display = "block"; // ƒê√£ c√≥
          document.getElementById("button-bar").style.display = "block";

          // T·∫°o l·∫°i thanh tr·∫°ng th√°i
          const statusBar = document.getElementById("question-status-bar");
          statusBar.innerHTML = "";
          quizQuestions.forEach((q, i) => {
            const box = document.createElement("div");
            box.className = "status-box";
            box.id = `status-box-${i}`;
            box.textContent = i + 1;
            box.onclick = () => goToQuestion(i);
            statusBar.appendChild(box);
          });

          show();
          updateScore();
          return true; // Kh√¥i ph·ª•c th√†nh c√¥ng
        }
        return false; // Kh√¥ng c√≥ phi√™n ƒë·ªÉ kh√¥i ph·ª•c
      }

      function exitQuiz() {
        // N·∫øu quiz ƒë√£ k·∫øt th√∫c (kh√¥ng c√≤n session), ch·ªâ c·∫ßn t·∫£i l·∫°i trang.
        // N·∫øu ch∆∞a, hi·ªÉn th·ªã c·∫£nh b√°o.
        if (
          sessionStorage.getItem("quizSession") &&
          confirm(
            "B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t kh·ªèi l∆∞·ª£t √¥n t·∫≠p n√†y? Ti·∫øn tr√¨nh s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u."
          )
        ) {
          sessionStorage.removeItem("quizSession");
          window.location.reload();
        } else if (!sessionStorage.getItem("quizSession")) {
          window.location.reload();
        }
      }

      // --- Logic ƒë·∫øm ng∆∞·ª£c th·ªùi gian ---
      function startTimerForCurrentQuestion() {
          const currentQuestion = quizQuestions[index];
          const timerDisplay = document.getElementById("timer-display");
          let duration;

          if (currentQuestion.isSubQuestion) {
            const isPassageTimerEnabled = document.getElementById('enable-passage-timer').checked;
            if (isPassageTimerEnabled) {
                duration = parseInt(document.getElementById('passage-timer-minutes').value) * 60;
            } else {
                timerDisplay.style.display = 'none';
                return; // Kh√¥ng b·∫≠t timer cho b√†i ƒë·ªçc
            }
          } else {
            const isSingleTimerEnabled = document.getElementById('enable-single-timer').checked;
            if (isSingleTimerEnabled) {
                duration = parseInt(document.getElementById('single-timer-seconds').value);
            } else {
                timerDisplay.style.display = 'none';
                return; // Kh√¥ng b·∫≠t timer cho c√¢u h·ªèi ƒë∆°n
            }
          }

          timerDisplay.style.display = 'inline-block';
          questionStartTime = Date.now();
          let timeLeft = duration;

          timerInterval = setInterval(() => {
              const minutes = Math.floor(timeLeft / 60);
              const seconds = timeLeft % 60;
              timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

              if (--timeLeft < 0) {
                  stopTimer();
                  next(); // T·ª± ƒë·ªông chuy·ªÉn c√¢u khi h·∫øt gi·ªù
              }
          }, 1000);
      }

      // --- Ch·ª©c nƒÉng Highlight v√† Ghi ch√∫ ---
      const highlightToolbar = document.getElementById('highlight-toolbar');
      let currentSelection = null;

      function showHighlightToolbar(x, y, forRemovalOnly = false) {
        highlightToolbar.style.left = `${x}px`;
        highlightToolbar.style.top = `${y}px`;
        highlightToolbar.style.display = 'block';

        // ·∫®n/hi·ªán b·∫£ng m√†u ho·∫∑c n√∫t x√≥a t√πy theo ng·ªØ c·∫£nh
        highlightToolbar.querySelector('.color-palette').style.display = forRemovalOnly ? 'none' : 'flex';
        highlightToolbar.querySelector('button[onclick="removeHighlight()"]').style.display = 'inline-block';
      }

      function hideHighlightToolbar() {
        highlightToolbar.style.display = 'none';
        currentSelection = null;
      }

      function handleTextSelection(event) {
        const selection = window.getSelection();
        if (selection.isCollapsed) {
          hideHighlightToolbar();
          return;
        }

        // Ch·ªâ hi·ªÉn th·ªã toolbar n·∫øu v√πng ch·ªçn n·∫±m trong khu v·ª±c cho ph√©p
        const passageContainer = document.getElementById('passage-content');
        const questionContainer = document.getElementById('quiz');
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;

        if (passageContainer.contains(container) || questionContainer.contains(container)) {
            currentSelection = selection.getRangeAt(0).cloneRange();
            const rect = range.getBoundingClientRect();
            showHighlightToolbar(rect.left + window.scrollX, rect.top + window.scrollY - highlightToolbar.offsetHeight - 5, false);
        } else {
            hideHighlightToolbar();
        }
      }

      function applyHighlight(color) {
        if (!currentSelection) return;

        const mark = document.createElement('mark');
        mark.id = `highlight-${Date.now()}`; // ID duy nh·∫•t
        mark.dataset.color = color; // G√°n m√†u ƒë√£ ch·ªçn
        try {
            currentSelection.surroundContents(mark);
            updateQuestionContentAfterAnnotation();
        } catch (e) {
            console.warn("Kh√¥ng th·ªÉ bao b·ªçc v√πng ch·ªçn, c√≥ th·ªÉ do ch·ªçn qua nhi·ªÅu th·∫ª HTML kh√°c nhau.", e);
        }
        hideHighlightToolbar();
      }

      function removeHighlight(markElement = null) {
        // This function was left empty in the previous diff, it should be here.
        // The logic was mistakenly placed inside applyHighlight.
      }

      function updateQuestionContentAfterAnnotation() {
          const currentQ = quizQuestions[index];
          if (currentQ.isSubQuestion) {
              currentQ.annotatedPassageContent = document.getElementById('passage-content').innerHTML;
          }
          currentQ.annotatedQuestion = document.querySelector('#quiz h3').innerHTML.split(': ')[1].split('<span')[0].trim();
          saveQuizSession();
      }
      
      function handleHighlightClick(event) {
          let target = event.target;
          // T√¨m th·∫ª <mark> cha g·∫ßn nh·∫•t
          while (target && target.tagName !== 'MARK' && target.id !== 'quiz-container') {
              target = target.parentNode;
          }

          if (target && target.tagName === 'MARK') {
              event.preventDefault(); // NgƒÉn c√°c h√†nh vi m·∫∑c ƒë·ªãnh kh√°c
              showHighlightToolbar(event.pageX + 5, event.pageY + 5, true);
              // G√°n l·∫°i s·ª± ki·ªán cho n√∫t x√≥a ƒë·ªÉ n√≥ bi·∫øt c·∫ßn x√≥a th·∫ª <mark> n√†o
              highlightToolbar.querySelector('button[onclick="removeHighlight()"]').onclick = () => removeHighlight(target);
          }
      }

      // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
      loadAllQuestions();

      // G·∫Øn s·ª± ki·ªán cho highlight
      document.getElementById('quiz-container').addEventListener('mouseup', handleTextSelection);
      document.getElementById('quiz-container').addEventListener('click', handleHighlightClick);
      document.addEventListener('mousedown', function(event) {
          if (!highlightToolbar.contains(event.target)) {
              hideHighlightToolbar();
          }
      });

      // G·∫Øn s·ª± ki·ªán mouseup cho c√°c √¥ contenteditable trong modal s·ª≠a
      document.getElementById('editQ').addEventListener('mouseup', handleMouseUp);
      document.getElementById('editExplanation').addEventListener('mouseup', handleMouseUp);
      document.getElementById('passageEditText').addEventListener('mouseup', handleMouseUp);
      document.getElementById('passageEditSubQuestions').addEventListener('mouseup', handleMouseUp);

    </script>
  </body>
</html>