<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>入力 - 文法練習</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 30px;
            background: #fafafa;
        }

        textarea,
        [contenteditable="true"] {
            width: 100%;
            margin-top: 5px;
            border: 1px solid #ccc;
            background: #fff;
            padding: 8px;
            border-radius: 4px;
        }

        textarea {
            height: 200px;
        }

        button {
            margin: 3px;
            padding: 4px 10px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 5px;
            vertical-align: top;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .multi-select-highlight {
            background-color: #fff8b9;
            /* Màu vàng để highlight */
        }

        #multiSelectToggle.active {
            background-color: #a0d2ff;
            /* Màu xanh khi chế độ được bật */
            border-color: #6b9ac4;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
            padding: 15px;
            /* Thêm z-index để đảm bảo modal luôn ở trên cùng */
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            /* Thay đổi để responsive */
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            box-sizing: border-box;
            /* Thêm flex để cố định footer */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .modal-footer {
            padding: 10px 20px;
            border-top: 1px solid #eee;
            text-align: right;
            flex-shrink: 0;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
        }
    </style>
</head>

<body>
    <h2>📘 Thêm câu hỏi mới</h2>

    <div id="add-question-area" style="border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div>
            <label><input type="radio" name="questionType" value="single" onchange="toggleInputType(this.value)"
                    checked> Câu hỏi
                đơn</label>
            <label style="margin-left: 15px;"><input type="radio" name="questionType" value="passage"
                    onchange="toggleInputType(this.value)"> Bài đọc (nhiều
                câu
                hỏi)</label>
        </div>

        <!-- Form cho câu hỏi đơn -->
        <div id="single-question-form" style="margin-top: 15px;">
            <div id="toolbarMulti" style="margin-bottom: 5px">
                <button id="multiSelectToggle" onclick="toggleMultiSelectMode(this)">✨
                    Chọn nhiều</button>
                <button onclick="formatMulti('bold')"><b>B</b></button>
                <button onclick="formatMulti('underline')"><u>U</u></button>
                <button onclick="formatMulti('strikeThrough')"><s>S</s></button>
                <button onclick="clearFormatMulti()">🧹 Clear</button>
            </div>
            <div id="quick" contenteditable="true" placeholder="Dán nhiều câu hỏi đơn có 正解 / 不正解..."
                style="min-height: 200px; white-space: pre-wrap"></div>
            <br />
            <button onclick="quickParse()">⚙️ Phân tích & Lưu câu hỏi
                đơn</button>
            <button type="button" onclick="clearSingleInput()">🗑️ Xóa nội
                dung</button>
        </div>

        <!-- Form cho bài đọc -->
        <div id="passage-form" style="display: none; margin-top: 15px;">
            <label for="passage-text"><b>Nội dung bài đọc:</b></label>
            <div id="passage-text" contenteditable="true" placeholder="Dán nội dung bài đọc vào đây..."
                style="min-height: 150px; white-space: pre-wrap"></div>
            <br>
            <label for="passage-sub-questions"><b>Các câu hỏi cho bài
                    đọc:</b></label>
            <!-- Thêm thanh công cụ định dạng cho câu hỏi của bài đọc -->
            <div id="toolbarPassage" style="margin-bottom: 5px">
                <button id="multiSelectTogglePassage" onclick="toggleMultiSelectMode(this, 'passage-sub-questions')">✨
                    Chọn nhiều</button>
                <button onclick="formatMulti('bold', 'passage-sub-questions')"><b>B</b></button>
                <button onclick="formatMulti('underline', 'passage-sub-questions')"><u>U</u></button>
                <button onclick="formatMulti('strikeThrough', 'passage-sub-questions')"><s>S</s></button>
                <button onclick="clearFormatMulti('passage-sub-questions')">🧹
                    Clear</button>
            </div>
            <div id="passage-sub-questions" contenteditable="true"
                placeholder="Dán các câu hỏi con (1. 2. ...) vào đây..."
                style="min-height: 150px; white-space: pre-wrap"></div>
            <br />
            <button onclick="savePassage()">⚙️ Lưu bài đọc & các câu
                hỏi</button>
            <button type="button" onclick="clearPassageInput()">🗑️ Xóa nội
                dung</button>
        </div>
    </div>
    <a href="./review.html">👉 Sang trang ôn tập</a>

    <h2>📋 Danh sách câu hỏi</h2>
    <input type="text" id="searchInput" oninput="render()" placeholder="Tìm kiếm trong câu hỏi..."
        style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
    <button onclick="exportJSON()">💾 Xuất dữ liệu</button>
    <button onclick="clearAll()">🗑 Xóa toàn bộ</button>
    <table id="tbl">
        <thead>
            <tr>
                <th>#</th>
                <th>Câu hỏi</th>
                <th>正解</th>
                <th>Thống kê (Đúng/Lần làm)</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-body">
                <h3>✏️ Sửa câu hỏi</h3>
                <label>Câu hỏi:</label>
                <div id="editQ" contenteditable="true" style="
              border: 1px solid #ccc;
              padding: 8px;
              min-height: 60px;
              background: #fff;
              white-space: pre-wrap;
            "></div>

                <div style="margin-top: 6px">
                    <button type="button" onclick="formatEdit('bold')"><b>B</b></button>
                    <button type="button" onclick="formatEdit('underline')">
                        <u>U</u>
                    </button>
                    <button type="button" onclick="formatEdit('strikeThrough')">
                        <s>S</s>
                    </button>
                    <button type="button" onclick="clearFormatEdit()">🧹
                        Clear</button>
                </div>

                <label>Đáp án 1:</label><input type="text" id="editC1" />
                <label>Đáp án 2:</label><input type="text" id="editC2" />
                <label>Đáp án 3:</label><input type="text" id="editC3" />
                <label>Đáp án 4:</label><input type="text" id="editC4" />
                <label>Đúng (1-4):</label><input type="number" id="editCorrect" min="1" max="4" />
                <label for="editExplanation">Giải thích (Tham khảo):</label>
                <textarea id="editExplanation" rows="4" style="width: 100%; margin-top: 5px;"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="saveEdit()">💾 Lưu</button>
                <button onclick="closeModal()">✖ Đóng</button>
            </div>
        </div>
    </div>

    <!-- Modal sửa BÀI ĐỌC -->
    <div class="modal" id="passageEditModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-body">
                <h3>✏️ Sửa bài đọc</h3>

                <label for="passageEditText"><b>Nội dung bài
                        đọc:</b></label>
                <div id="passageEditText" contenteditable="true" style="min-height: 150px; white-space: pre-wrap"></div>
                <br>

                <label for="passageEditSubQuestions"><b>Các câu hỏi cho bài
                        đọc:</b></label>
                <div id="toolbarPassageEdit" style="margin-bottom: 5px">
                    <button onclick="toggleMultiSelectMode(this, 'passageEditSubQuestions')">✨
                        Chọn nhiều</button>
                    <button onclick="formatMulti('bold', 'passageEditSubQuestions')"><b>B</b></button>
                    <button onclick="formatMulti('underline', 'passageEditSubQuestions')"><u>U</u></button>
                    <button onclick="formatMulti('strikeThrough', 'passageEditSubQuestions')"><s>S</s></button>
                    <button onclick="clearFormatMulti('passageEditSubQuestions')">🧹
                        Clear</button>
                </div>
                <div id="passageEditSubQuestions" contenteditable="true"
                    style="min-height: 200px; white-space: pre-wrap"></div>
            </div>
            <div class="modal-footer">
                <button onclick="savePassageEdit()">💾 Lưu thay đổi</button>
                <button onclick="closePassageModal()">✖ Đóng</button>
            </div>
        </div>
    </div>
    <div class="modal" id="dupModal">
        <div class="modal-content">
            <div class="modal-body">
                <h3>⚠️ Câu hỏi trùng lặp</h3>
                <p>Chọn những câu bạn muốn <b>ghi đè</b>:</p>
                <div id="dupList" style="margin-top:8px; border:1px solid #ccc; padding:6px; background:#fafafa;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="confirmDup()">✅ Xác nhận</button>
                <button onclick="closeDup()">✖ Đóng</button>
            </div>
        </div>
    </div>

    <!-- Modal xem trước bài đọc -->
    <div class="modal" id="passagePreviewModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-body">
                <h3>🔍 Xem trước bài đọc & câu hỏi</h3>
                <h4>Nội dung bài đọc:</h4>
                <div id="previewPassageContent"
                    style="background: #f9f9f9; border: 1px solid #eee; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                </div>

                <h4 style="margin-top: 20px;">Các câu hỏi đã phân tích:</h4>
                <div id="previewSubQuestionsList"></div>
            </div>
            <div class="modal-footer">
                <button onclick="confirmSavePassage()">✅ Xác nhận &
                    Lưu</button>
                <button onclick="closePassagePreviewModal()">✖ Hủy</button>
            </div>
        </div>
    </div>

    <!-- Modal xem trước câu hỏi đơn -->
    <div class="modal" id="parsePreviewModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-body">
                <h3>🔍 Xem trước các câu hỏi đã phân tích</h3>
                <p>Chọn những câu hỏi bạn muốn lưu. Bỏ chọn những câu phân tích sai hoặc không muốn thêm.</p>
                <div id="parsePreviewList" style="margin-top: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="confirmQuickParse()">✅ Xác nhận & Lưu các câu đã chọn</button>
                <button onclick="closeParsePreviewModal()">✖ Hủy</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Tải cấu hình và khởi tạo Firebase từ file riêng -->
    <script src="./firebase-init.js"></script>

    <script>
        let questions = []; // Dữ liệu sẽ được tải từ Firebase
        let editIndex = -1;
        let tempParsedQuestions = []; // Lưu các câu hỏi đã phân tích tạm thời
        let isMultiSelectMode = false;

        // Tải dữ liệu từ Firestore
        async function loadQuestions() {
            try {
                // Tải câu hỏi, sắp xếp theo timestamp mới nhất lên đầu
                const snapshot = await questionsCollection.orderBy("timestamp", "desc").get();
                questions = snapshot.docs.map(doc => ({
                    id: doc.id, // Lưu ID của document để thao tác sửa/xóa
                    ...doc.data()
                }));
                render();
            } catch (error) {
                console.error("Lỗi khi tải câu hỏi:", error);
                alert("Lỗi khi tải câu hỏi. Kiểm tra console.");
            }
        }

        function render() {
            const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";
            const tbody = document.querySelector("#tbl tbody");
            tbody.innerHTML = "";

            const filteredQuestions = questions.filter(q => {
                // Tìm kiếm trên nội dung text của câu hỏi, không bao gồm HTML
                if (!q) return false;
                let contentToSearch = "";
                if (q.type === 'passage') {
                    // Đối với bài đọc, tìm kiếm trong nội dung bài đọc
                    contentToSearch = q.passage || "";
                } else {
                    // Đối với câu hỏi đơn, tìm kiếm trong nội dung câu hỏi
                    contentToSearch = q.question || "";
                }
                return contentToSearch.replace(/<[^>]+>/g, "").toLowerCase().includes(searchTerm);
            });

            // Tách thành 2 nhóm
            const passages = filteredQuestions.filter(q => q.type === 'passage');
            const singles = filteredQuestions.filter(q => q.type !== 'passage');

            // Hiển thị nhóm Bài đọc
            if (passages.length > 0) {
                const headerRow = tbody.insertRow();
                headerRow.innerHTML = `<th colspan="5" style="background-color: #eef; text-align: left;">📚 Bài đọc (${passages.length})</th>`;
                passages.forEach((q, index) => renderRow(q, index));
            }

            // Hiển thị nhóm Câu hỏi đơn
            if (singles.length > 0) {
                const headerRow = tbody.insertRow();
                headerRow.innerHTML = `<th colspan="5" style="background-color: #eff; text-align: left;">📝 Câu hỏi đơn (${singles.length})</th>`;
                singles.forEach((q, index) => renderRow(q, index));
            }

            // Hàm phụ để render một dòng
            function renderRow(q, displayIndex) {
                // Tìm index gốc của câu hỏi trong mảng `questions` để các hàm sửa/xóa hoạt động đúng
                const originalIndex = questions.findIndex(originalQ => originalQ.id === q.id);
                if (originalIndex === -1) return; // Bỏ qua nếu không tìm thấy

                const tr = document.createElement("tr");
                if (q.type === 'passage' && q.sub_questions) {
                    const totalAttemptedSubQuestions = (q.attempts || 0) * (q.totalSubQuestions || q.sub_questions.length);
                    tr.innerHTML = `
                        <td>${displayIndex + 1}</td>
                        <td>
                            <div style="font-weight: bold; color: #005a9e;">[BÀI ĐỌC]</div>
                            <div>${q.passage.substring(0, 150)}... (${q.sub_questions.length} câu hỏi)</div>
                        </td>
                        <td>-</td>
                        <td style="text-align: center;">${q.correctAttempts || 0}/${totalAttemptedSubQuestions}</td>
                        <td><button onclick="openEdit(${originalIndex})">Sửa</button><button onclick="del(${originalIndex})">Xóa</button></td>`;
                } else { // Mặc định là câu hỏi đơn
                    tr.innerHTML = `
                        <td>${displayIndex + 1}</td>
                        <td>${q.question}</td>
                        <td>${q.choices[q.correct] || ""}</td>
                        <td style="text-align: center;">${q.correctAttempts || 0}/${q.attempts || 0}</td>
                        <td><button onclick="openEdit(${originalIndex})">Sửa</button><button onclick="del(${originalIndex})">Xóa</button></td>`;
                }
                tbody.appendChild(tr);
            }
        }

        let tempDup = []; // lưu danh sách trùng tạm
        let tempPassageData = null; // Dữ liệu bài đọc tạm thời cho việc xem trước

        // 🔹 Hàm tái sử dụng để phân tích câu hỏi từ HTML (ĐÃ SỬA HOÀN TOÀN)
        function parseQuestionsFromHTML(html) {
            const questions = [];
            if (!html) return questions;

            const safeHTML = html
                .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, "")
                .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, "");

            // Chuẩn hóa và tách dòng - GIỮ NGUYÊN ĐỊNH DẠNG HTML
            const allLines = safeHTML
                .replace(/<div>/g, "\n")
                .replace(/<\/div>/g, "")
                .replace(/<br\s*\/?>/gi, "\n")
                .replace(/<\/p>/gi, "\n")
                .split("\n")
                .map(x => x.trim())
                .filter(x => x);

            // Phân tích theo từng khối câu hỏi dựa trên số thứ tự
            let currentBlock = [];
            let blocks = [];

            allLines.forEach(line => {
                // Phát hiện bắt đầu câu hỏi mới: số theo sau bởi dấu chấm
                if (line.match(/^\s*\d+\.\s/) || line.match(/^\s*\d+\s*$/)) {
                    if (currentBlock.length > 0) {
                        blocks.push([...currentBlock]);
                        currentBlock = [];
                    }
                }
                currentBlock.push(line);
            });

            if (currentBlock.length > 0) {
                blocks.push(currentBlock);
            }

            // Phân tích từng khối
            blocks.forEach(block => {
                const question = parseSingleQuestionBlock(block);
                if (question) {
                    questions.push(question);
                }
            });

            return questions;
        }

        // 🔹 Hàm phân tích một khối câu hỏi đơn lẻ
        function parseSingleQuestionBlock(blockLines) {
            if (blockLines.length === 0) return null;

            let questionText = "";
            const choices = [];
            let correctAnswer = -1;
            let explanation = "";

            // Xác định dòng đầu tiên (câu hỏi chính)
            const firstLine = blockLines[0];
            // Loại bỏ số thứ tự ở đầu dòng
            questionText = firstLine.replace(/^\s*\d+\.?\s*/, "");

            // Xử lý trường hợp chỉ có số thứ tự, không có nội dung câu hỏi
            if (!questionText.trim()) {
                questionText = `(Câu hỏi ${firstLine.replace(/\D/g, "")})`;
            }

            // Biến tạm để thu thập các dòng tiếp theo của câu hỏi
            let collectingQuestion = true;
            let tempQuestionLines = [questionText];
            
            // Đếm số lựa chọn đã tìm thấy để xác định khi nào dừng thu thập câu hỏi
            let choicesFoundCount = 0;

            // Duyệt các dòng còn lại
            for (let i = 1; i < blockLines.length; i++) {
                const line = blockLines[i];

                // Kiểm tra các pattern đặc biệt trước

                // 1. Dòng đáp án đúng: "正解: X) Nội dung" hoặc "正解: X"
                const correctLineMatch = line.match(/正解\s*[:：]\s*(\d+)\)\s*(.*)/);
                if (correctLineMatch) {
                    correctAnswer = parseInt(correctLineMatch[1]) - 1;
                    const choiceText = correctLineMatch[2].trim();
                    if (choiceText) {
                        choices[correctAnswer] = choiceText;
                    }
                    // Nếu đã tìm thấy ít nhất 2 lựa chọn, có thể chắc chắn đây không phải là một phần của câu hỏi nữa.
                    if (choices.filter(c => c).length >= 2) {
                        collectingQuestion = false;
                    }
                    continue;
                }

                // 2. Dòng đáp án đơn giản: "正解: X"
                const correctSimpleMatch = line.match(/正解\s*[:：]\s*(\d+)\s*$/);
                if (correctSimpleMatch) {
                    correctAnswer = parseInt(correctSimpleMatch[1]) - 1;
                    if (choices.filter(c => c).length >= 2) {
                        collectingQuestion = false;
                    }
                    continue;
                }

                // 3. Dòng đáp án sai: "不正解: X) Nội dung"
                const incorrectLineMatch = line.match(/不正解\s*[:：]\s*(\d+)\)\s*(.*)/);
                if (incorrectLineMatch) {
                    const choiceIndex = parseInt(incorrectLineMatch[1]) - 1;
                    const choiceText = incorrectLineMatch[2].trim();
                    choices[choiceIndex] = choiceText;
                    if (choices.filter(c => c).length >= 2) {
                        collectingQuestion = false;
                    }
                    continue;
                }

                // 4. Lựa chọn thông thường: "X) Nội dung"
                const choiceMatch = line.match(/^\s*(\d+)\)\s*(.*)/);
                if (choiceMatch) {
                    const choiceIndex = parseInt(choiceMatch[1]) - 1;
                    let choiceText = choiceMatch[2].trim();

                    // Xử lý trường hợp có "正解" trong lựa chọn
                    if (choiceText.includes("正解")) {
                        correctAnswer = choiceIndex;
                        choiceText = choiceText.replace(/\s*正解\s*/, "").trim();
                    }
                    // Xử lý trường hợp có "不正解" trong lựa chọn
                    if (choiceText.includes("不正解")) {
                        choiceText = choiceText.replace(/\s*不正解\s*/, "").trim();
                    }

                    choices[choiceIndex] = choiceText;
                    choicesFoundCount++;

                    // Chỉ dừng thu thập câu hỏi khi đã tìm thấy ít nhất 2 lựa chọn.
                    if (choicesFoundCount >= 2) {
                        collectingQuestion = false;
                    }
                    continue;
                }

                // 5. Giải thích
                const explanationMatch = line.match(/^(Tham khảo|Giải thích|参考)\s*[:：]\s*(.*)/i);
                if (explanationMatch) {
                    explanation = explanationMatch[2].trim();
                    collectingQuestion = false;
                    continue;
                }

                // 6. Nếu không khớp với pattern nào và vẫn đang thu thập câu hỏi
                if (collectingQuestion) {
                    tempQuestionLines.push(line);
                }
            }

            // Ghép các dòng câu hỏi lại
            questionText = tempQuestionLines.join("<br>");

            // Điền các lựa chọn còn thiếu (nếu có)
            for (let i = 0; i < 4; i++) {
                if (!choices[i]) {
                    choices[i] = "";
                }
            }

            // Nếu không tìm thấy dòng "正解" nào, giả định lựa chọn đầu tiên là đúng
            if (correctAnswer === -1 && choices.filter(c => c && c.trim() !== "").length > 0) {
                correctAnswer = 0;
            }

            // Chỉ trả về câu hỏi nếu có ít nhất 2 lựa chọn và đáp án đúng được xác định
            const filledChoices = choices.filter(c => c && c.trim() !== "");
            if (filledChoices.length >= 2 && correctAnswer !== -1 && correctAnswer < choices.length) {
                return {
                    question: questionText,
                    choices: choices,
                    correct: correctAnswer,
                    explanation: explanation
                };
            }

            return null;
        }
        // 🔹 Hàm phụ để phân tích một câu hỏi duy nhất từ nội dung
        function parseSingleQuestionFromContent(lines) {
            const question = {
                question: "",
                choices: [],
                correct: -1,
                explanation: ""
            };

            let foundChoices = false;
            let questionLines = [];

            lines.forEach(line => {
                // Xác định dòng câu hỏi (không phải lựa chọn và không phải đáp án)
                const isChoice = line.match(/^\s*(\d+)\)/);
                const isCorrectAnswer = line.match(/正解\s*[:：]?\s*(\d+)/);
                const isIncorrectMarker = line.match(/不正解\s*[:：]?\s*(\d+\))/);

                if (!isChoice && !isCorrectAnswer && !isIncorrectMarker && !foundChoices) {
                    questionLines.push(line);
                } else {
                    foundChoices = true;

                    // Xử lý lựa chọn
                    const choiceMatch = line.match(/^\s*(\d+)\)\s*(.*)/);
                    if (choiceMatch) {
                        const choiceNum = parseInt(choiceMatch[1]);
                        let choiceText = choiceMatch[2].trim();

                        // Xử lý "不正解" ở đầu
                        if (choiceText.startsWith("不正解")) {
                            choiceText = choiceText.replace(/^不正解\s*[:：]?\s*/, "");
                        }

                        // Xử lý "正解" trong lựa chọn
                        if (choiceText.includes("正解")) {
                            question.correct = choiceNum - 1;
                            choiceText = choiceText.replace(/\s*正解\s*$/, "").replace(/\s*正解\s*[:：]\s*/, "");
                        }

                        question.choices[choiceNum - 1] = choiceText;
                    }

                    // Xử lý đáp án đúng riêng biệt
                    const correctMatch = line.match(/正解\s*[:：]?\s*(\d+)/);
                    if (correctMatch) {
                        question.correct = parseInt(correctMatch[1]) - 1;
                    }
                }
            });

            question.question = questionLines.join("<br>");

            // Nếu vẫn không có câu hỏi, sử dụng dòng đầu tiên
            if (!question.question && lines.length > 0) {
                question.question = lines[0];
            }

            return question.choices.length >= 2 && question.correct !== -1 ? [question] : [];
        }

        function populateAndShowParsePreviewModal(parsedQuestions) {
            tempParsedQuestions = parsedQuestions;
            const previewList = document.getElementById('parsePreviewList');
            previewList.innerHTML = ""; // Xóa nội dung cũ

            parsedQuestions.forEach((q, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.id = `preview-item-${index}`;
                itemDiv.style = "border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #f9f9f9;";
                itemDiv.innerHTML = getParsedQuestionHTML(q, index);
                previewList.appendChild(itemDiv);
            });

            document.getElementById('parsePreviewModal').style.display = 'flex';
        }

        function getParsedQuestionHTML(q, index, isEditing = false) {
            if (isEditing) {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: bold;"><input type="checkbox" class="parse-preview-checkbox" data-index="${index}" checked> Câu hỏi ${index + 1}</label>
                        <button onclick="saveParsedQuestionEdit(${index})">💾 Lưu</button>
                    </div>
                    <div id="toolbar-preview-edit-${index}" style="margin-bottom: 5px; border: 1px solid #eee; padding: 3px; border-radius: 4px;">
                        <button onclick="toggleMultiSelectMode(this, 'edit-preview-q-${index}')" title="Chọn nhiều">✨</button>
                        <button onclick="formatMulti('bold', 'edit-preview-q-${index}')"><b>B</b></button>
                        <button onclick="formatMulti('underline', 'edit-preview-q-${index}')"><u>U</u></button>
                        <button onclick="formatMulti('strikeThrough', 'edit-preview-q-${index}')"><s>S</s></button>
                        <button onclick="clearFormatMulti('edit-preview-q-${index}')" title="Xóa định dạng">🧹</button>
                    </div>
                    <div contenteditable="true" id="edit-preview-q-${index}" style="border: 1px dashed #ccc; padding: 5px; margin-bottom: 5px; background: white;">${q.question}</div>
                    ${[0, 1, 2, 3].map(cIndex => `
                        <div style="display: flex; align-items: center; margin-bottom: 3px;">
                            <span style="margin-right: 5px;">${cIndex + 1})</span>
                            <input type="text" id="edit-preview-c-${index}-${cIndex}" value="${q.choices[cIndex] || ''}" style="flex-grow: 1; padding: 3px;">
                        </div>
                    `).join('')}
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <label for="edit-preview-correct-${index}" style="margin-right: 5px;">Đáp án đúng (1-4):</label>
                        <input type="number" id="edit-preview-correct-${index}" value="${q.correct + 1}" min="1" max="4" style="width: 60px;">
                    </div>
                     <div style="margin-top: 5px;">
                        <label for="edit-preview-explanation-${index}" style="display:block; margin-bottom: 3px;">Giải thích:</label>
                        <textarea id="edit-preview-explanation-${index}" style="width: 100%; font-size: 13px;" rows="2">${q.explanation || ''}</textarea>
                    </div>
                `;
            } else {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: bold; flex-grow: 1;">
                            <input type="checkbox" class="parse-preview-checkbox" data-index="${index}" checked>
                            Câu hỏi ${index + 1}: ${q.question}
                        </label>
                        <button onclick="editParsedQuestion(${index})">✏️ Sửa</button>
                    </div>
                    <ul>
                        ${q.choices.map((choice, cIndex) => `
                            <li style="${cIndex === q.correct ? 'font-weight: bold; color: green;' : ''}">
                                ${cIndex + 1}) ${choice}
                            </li>
                        `).join('')}
                    </ul>
                    ${q.explanation ? `<div style="margin-top: 8px; padding: 5px; background-color: #e9e9e9; border-radius: 3px;"><b>Giải thích:</b> ${q.explanation}</div>` : ''}
                `;
            }
        }

        function editParsedQuestion(index) {
            const q = tempParsedQuestions[index];
            const itemDiv = document.getElementById(`preview-item-${index}`);
            itemDiv.innerHTML = getParsedQuestionHTML(q, index, true);
            // Gắn sự kiện để chế độ "Chọn nhiều" hoạt động
            document.getElementById(`edit-preview-q-${index}`).addEventListener("mouseup", handleMouseUp);
        }

        function saveParsedQuestionEdit(index) {
            const q = tempParsedQuestions[index];
            // Xóa các highlight của chế độ "Chọn nhiều" trước khi lưu
            removeHighlights(`edit-preview-q-${index}`);
            q.question = document.getElementById(`edit-preview-q-${index}`).innerHTML;
            q.choices = [0, 1, 2, 3].map(cIndex => document.getElementById(`edit-preview-c-${index}-${cIndex}`).value);
            q.correct = parseInt(document.getElementById(`edit-preview-correct-${index}`).value) - 1;
            q.explanation = document.getElementById(`edit-preview-explanation-${index}`).value;

            const itemDiv = document.getElementById(`preview-item-${index}`);
            itemDiv.innerHTML = getParsedQuestionHTML(q, index, false);
            // Đảm bảo checkbox vẫn được chọn sau khi lưu
            itemDiv.querySelector('.parse-preview-checkbox').checked = true;
        }

        function closeParsePreviewModal() {
            document.getElementById('parsePreviewModal').style.display = 'none';
            tempParsedQuestions = [];
        }

        // 🔹 Phân tích nhiều câu hỏi (Đã sửa để dùng Firestore)
        async function quickParse() {
            const html = document.getElementById("quick").innerHTML.trim();
            if (!html) return alert("Hãy dán nội dung!");

            const safeHTML = html
                .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, "")
                .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, "");

            const parsed = parseQuestionsFromHTML(safeHTML);
            const newQuestions = parsed.map(q => ({ ...q, type: 'single', attempts: 0, correctAttempts: 0 }));

            if (newQuestions.length === 0) {
                alert("⚠️ Không phân tích được câu hỏi nào!");
                return;
            }

            // Hiển thị modal xem trước thay vì xử lý ngay
            populateAndShowParsePreviewModal(newQuestions);
        }

        async function confirmQuickParse() {
            const selectedCheckboxes = document.querySelectorAll('.parse-preview-checkbox:checked');
            const selectedQuestions = Array.from(selectedCheckboxes).map(cb => {
                const index = parseInt(cb.getAttribute('data-index'));
                return tempParsedQuestions[index];
            });

            if (selectedQuestions.length === 0) {
                alert("Bạn chưa chọn câu hỏi nào để lưu.");
                return;
            }
            const current = questions; // Dùng biến questions đã load từ Firestore
            const duplicates = [];
            const unique = [];

            for (const nq of selectedQuestions) {
                const dup = current.find(q =>
                    // Chỉ so sánh nếu q là câu hỏi đơn và có thuộc tính 'question'
                    q.type !== 'passage' && q.question &&
                    q.question.replace(/<[^>]+>/g, "").trim() === nq.question.replace(/<[^>]+>/g, "").trim()
                );
                if (dup) {
                    duplicates.push({ ...nq, oldId: dup.id }); // Lưu cả ID cũ để ghi đè
                }
                else {
                    unique.push(nq);
                }
            }

            if (duplicates.length > 0) {
                tempDup = { duplicates, unique }; // Không cần current vì đã có ID
                const list = document.getElementById("dupList");
                list.innerHTML = duplicates.map((q, i) => `
            <div style="margin-bottom:8px; background:#fff; padding:6px; border-radius:4px;">
              <label>
                <input type="checkbox" checked id="dup_${i}" />
                <span>${q.question}</span>
              </label>
            </div>
          `).join("");
                document.getElementById("dupModal").style.display = "flex";
            } else {
                // Lưu tất cả câu hỏi mới vào Firestore
                await Promise.all(unique.map(q => questionsCollection.add({
                    ...q,
                    timestamp: serverTimestamp()
                    // attempts và correctAttempts đã được thêm ở trên
                }))).then(() => {
                    alert(`✅ Đã thêm ${unique.length} câu hỏi mới (giữ định dạng HTML).`);
                });
                closeParsePreviewModal();
                await loadQuestions(); // Tải lại danh sách
            }
        }

        async function confirmDup() {
            const { duplicates, unique } = tempDup;
            const selected = [];
            const newUnique = [];
            let updatedCount = 0;
            let addedCount = 0;

            // 1. Xử lý các câu hỏi trùng lặp được chọn để ghi đè (UPDATE)
            const updatePromises = [];
            duplicates.forEach((q, i) => {
                const cb = document.getElementById(`dup_${i}`);
                if (cb && cb.checked) {
                    // Ghi đè câu hỏi cũ bằng dữ liệu mới, dùng ID cũ (q.oldId)
                    updatePromises.push(questionsCollection.doc(q.oldId).update({
                        question: q.question,
                        choices: q.choices,
                        correct: q.correct,
                        timestamp: serverTimestamp()
                        // Không reset attempts khi ghi đè, chỉ cập nhật nội dung
                    }));
                    updatedCount++;
                }
            });

            // 2. Xử lý các câu hỏi hoàn toàn mới (ADD)
            const addPromises = unique.map(q => {
                addedCount++;
                return questionsCollection.add({
                    ...q,
                    timestamp: serverTimestamp()
                });
            });

            await Promise.all([...updatePromises, ...addPromises]);
            await loadQuestions(); // Tải lại danh sách

            closeDup();

            alert(`✅ Đã hoàn thành. Đã ghi đè ${updatedCount} câu hỏi và thêm ${addedCount} câu hỏi mới.`);
        }

        // 🔹 Lưu bài đọc
        async function savePassage() {
            const passageHTML = document.getElementById("passage-text").innerHTML.trim();
            const subQuestionsHTML = document.getElementById("passage-sub-questions").innerHTML.trim();

            if (!passageHTML) return alert("Vui lòng nhập nội dung bài đọc.");
            if (!subQuestionsHTML) return alert("Vui lòng nhập các câu hỏi cho bài đọc.");

            const sub_questions = parseQuestionsFromHTML(subQuestionsHTML);

            if (sub_questions.length === 0) {
                return alert("Không phân tích được câu hỏi con nào. Vui lòng kiểm tra định dạng.");
            }

            // Lưu dữ liệu tạm thời để xác nhận
            tempPassageData = {
                type: 'passage',
                passage: passageHTML,
                sub_questions: sub_questions,
                attempts: 0,
                correctAttempts: 0,
                totalSubQuestions: sub_questions.length, // Thêm tổng số câu hỏi con
            };

            // Hiển thị modal xem trước
            populateAndShowPreviewModal();
        }

        async function confirmSavePassage() {
            if (!tempPassageData) return;

            const passageData = {
                ...tempPassageData,
                timestamp: serverTimestamp()
            };

            try {
                await questionsCollection.add(passageData);
                alert(`✅ Đã lưu bài đọc với ${passageData.sub_questions.length} câu hỏi thành công!`);
                document.getElementById("passage-text").innerHTML = "";
                document.getElementById("passage-sub-questions").innerHTML = "";
                closePassagePreviewModal();
                await loadQuestions();
            } catch (error) {
                console.error("Lỗi khi lưu bài đọc:", error);
                alert("Đã xảy ra lỗi khi lưu bài đọc. Vui lòng kiểm tra console.");
            }
        }

        function populateAndShowPreviewModal() {
            if (!tempPassageData) return;

            document.getElementById('previewPassageContent').innerHTML = tempPassageData.passage;

            const previewList = document.getElementById('previewSubQuestionsList');
            previewList.innerHTML = tempPassageData.sub_questions.map((sq, index) => `
                <div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                    <p><b>Câu hỏi ${index + 1}:</b> ${sq.question}</p>
                    <ul>
                        ${sq.choices.map((choice, cIndex) => `
                            <li style="${cIndex === sq.correct ? 'font-weight: bold; color: green;' : ''}">
                                ${cIndex + 1}) ${choice} ${cIndex === sq.correct ? '<b>(Đáp án đúng)</b>' : ''}
                            </li>
                        `).join('')}
                    </ul>
                    ${sq.explanation ? `<div style="margin-top: 8px; padding: 5px; background-color: #f0f0f0; border-radius: 3px;"><b>Giải thích:</b> ${sq.explanation}</div>` : ''}
                </div>
            `).join('');

            document.getElementById('passagePreviewModal').style.display = 'flex';
        }

        function closeDup() {
            document.getElementById("dupModal").style.display = "none";
            tempDup = [];
        }

        // 🔹 Chỉnh sửa (Đã sửa để dùng Firestore)
        function openEdit(i) {
            editIndex = i;
            const q = questions[i];

            if (q.type === 'passage') {
                document.getElementById("passageEditText").innerHTML = q.passage;
                document.getElementById("passageEditSubQuestions").innerHTML = formatSubQuestionsForEditing(q.sub_questions);
                document.getElementById("passageEditModal").style.display = "flex";
            } else {
                document.getElementById("editQ").innerHTML = q.question;
                document.getElementById("editC1").value = q.choices[0] || "";
                document.getElementById("editC2").value = q.choices[1] || "";
                document.getElementById("editC3").value = q.choices[2] || "";
                document.getElementById("editC4").value = q.choices[3] || "";
                document.getElementById("editCorrect").value = q.correct + 1;
                document.getElementById("editExplanation").value = q.explanation || ""; // Hiển thị giải thích cũ
                document.getElementById("editModal").style.display = "flex";
            }
        }

        // Helper để format câu hỏi con cho việc sửa
        function formatSubQuestionsForEditing(subQuestions) {
            if (!subQuestions) return "";
            return subQuestions.map((sq, index) => {
                const choicesStr = sq.choices.map((choice, cIndex) => `${cIndex + 1}) ${choice}`).join('\n');
                const correctStr = `正解: ${sq.correct + 1}`;
                const explanationStr = sq.explanation ? `\nTham khảo: ${sq.explanation}` : '';
                return `${index + 1}. ${sq.question}\n${choicesStr}\n${correctStr}${explanationStr}`;
            }).join('\n\n'); // Thêm dòng trống giữa các câu hỏi
        }

        // Lưu chỉnh sửa cho BÀI ĐỌC
        async function savePassageEdit() {
            const q = questions[editIndex];
            const passageHTML = document.getElementById("passageEditText").innerHTML.trim();
            const subQuestionsHTML = document.getElementById("passageEditSubQuestions").innerHTML.trim();

            if (!passageHTML || !subQuestionsHTML) {
                return alert("Nội dung bài đọc và câu hỏi không được để trống.");
            }

            const sub_questions = parseQuestionsFromHTML(subQuestionsHTML);
            if (sub_questions.length === 0) {
                return alert("Không phân tích được câu hỏi con nào. Vui lòng kiểm tra lại định dạng.");
            }

            const updatedData = {
                passage: passageHTML,
                sub_questions: sub_questions,
                totalSubQuestions: sub_questions.length, // Cập nhật lại tổng số câu hỏi con
                timestamp: serverTimestamp()
            };

            try {
                await questionsCollection.doc(q.id).update(updatedData);
                closePassageModal();
                await loadQuestions();
            } catch (error) {
                console.error("Lỗi khi lưu bài đọc:", error);
                alert("Lỗi khi lưu bài đọc. Kiểm tra console.");
            }
        }

        async function saveEdit() {
            const q = questions[editIndex];

            if (q.type === 'passage') {
                alert("Chức năng sửa bài đọc chưa được hỗ trợ trong phiên bản này.");
                return;
            }

            const updatedData = {
                question: document.getElementById("editQ").innerHTML,
                choices: [
                    document.getElementById("editC1").value,
                    document.getElementById("editC2").value,
                    document.getElementById("editC3").value,
                    document.getElementById("editC4").value,
                ],
                correct: parseInt(document.getElementById("editCorrect").value) - 1,
                explanation: document.getElementById("editExplanation").value.trim(), // Lưu giải thích mới
                // Cập nhật lại timestamp
                timestamp: serverTimestamp()
            };

            try {
                // Cập nhật document bằng ID đã lưu (q.id)
                await questionsCollection.doc(q.id).update(updatedData);
                closeModal();
                await loadQuestions(); // Tải lại để cập nhật hiển thị
            } catch (error) {
                console.error("Lỗi khi lưu chỉnh sửa:", error);
                alert("Lỗi khi lưu chỉnh sửa. Kiểm tra console.");
            }
        }

        // Xóa (Đã sửa để dùng Firestore)
        async function del(i) {
            if (confirm("Xóa câu hỏi này?")) {
                try {
                    const questionId = questions[i].id;
                    await questionsCollection.doc(questionId).delete();
                    await loadQuestions(); // Tải lại danh sách
                } catch (error) {
                    console.error("Lỗi khi xóa câu hỏi:", error);
                    alert("Lỗi khi xóa câu hỏi. Kiểm tra console.");
                }
            }
        }

        function closeModal() {
            document.getElementById("editModal").style.display = "none";
        }

        function closePassageModal() {
            document.getElementById("passageEditModal").style.display = "none";
        }

        function closePassagePreviewModal() {
            document.getElementById('passagePreviewModal').style.display = 'none';
            tempPassageData = null;
        }

        // Xuất JSON (Dùng dữ liệu đã được tải)
        function exportJSON() {
            // Loại bỏ trường ID Firebase khỏi dữ liệu xuất
            const exportData = questions.map(({ id, ...rest }) => rest);
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: "application/json",
            });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "questions.json";
            a.click();
        }

        // Xóa toàn bộ (Đã sửa để dùng Batch Delete)
        async function clearAll() {
            if (confirm("Xóa toàn bộ câu hỏi? Hành động này không thể hoàn tác!")) {
                try {
                    // Tải lại tất cả ID lần nữa để đảm bảo
                    const snapshot = await questionsCollection.get();
                    if (snapshot.docs.length === 0) return;

                    // Dùng Write Batch để xóa nhiều document
                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    questions = [];
                    render();
                    alert("✅ Đã xóa toàn bộ câu hỏi thành công.");
                } catch (error) {
                    console.error("Lỗi khi xóa toàn bộ câu hỏi:", error);
                    alert("Lỗi khi xóa toàn bộ câu hỏi. Kiểm tra console.");
                }
            }
        }

        // 🔹 Format trong modal chỉnh sửa
        function formatEdit(cmd) {
            document.execCommand(cmd, false, null);
            document.getElementById("editQ").focus();
        }
        function clearFormatEdit() {
            document.execCommand("removeFormat", false, null);
            document.getElementById("editQ").focus();
        }

        // 🔹 Format trong vùng dán nhanh
        function formatMulti(cmd, targetId = 'quick') {
            const targetDiv = document.getElementById(targetId);
            if (!targetDiv) return;
            const highlighted = targetDiv.querySelectorAll(
                ".multi-select-highlight"
            );

            if (highlighted.length > 0) {
                document.execCommand("styleWithCSS", false, false);
                highlighted.forEach((span) => {
                    const range = document.createRange();
                    range.selectNodeContents(span);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    document.execCommand(cmd, false, null);
                    selection.removeAllRanges();
                });
            } else {
                document.execCommand(cmd, false, null);
            }
            targetDiv.focus();
        }

        function clearFormatMulti(targetId = 'quick') {
            removeHighlights(targetId);
            document.execCommand("removeFormat", false, null);
            document.getElementById(targetId)?.focus();
        }

        // 🔹 Chế độ chọn nhiều
        function toggleMultiSelectMode(btn, targetId = 'quick') {
            // Tắt chế độ cũ nếu có
            document.querySelectorAll('#toolbarMulti .active, #toolbarPassage .active').forEach(b => b.classList.remove('active'));

            const isActive = btn.classList.contains('active');
            isMultiSelectMode = !isActive;
            btn.classList.toggle("active", isMultiSelectMode);

            if (!isMultiSelectMode) {
                removeHighlights(targetId);
            }
        }

        function handleMouseUp(e) {
            const targetDiv = e.currentTarget; // Đây là div contenteditable

            // Tìm thanh công cụ tương ứng với div này
            const toolbar = targetDiv.previousElementSibling;
            if (!toolbar || !toolbar.id.startsWith('toolbar-')) return;

            // Tìm nút "Chọn nhiều" đang active trong thanh công cụ đó
            const toggleButton = toolbar.querySelector('button.active');
            if (!toggleButton || !toggleButton.classList.contains('active')) return;

            const selection = window.getSelection();
            if (selection.isCollapsed || !selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            if (!targetDiv.contains(range.commonAncestorContainer)) return;

            const span = document.createElement("span");
            span.className = "multi-select-highlight";
            range.surroundContents(span);
            selection.removeAllRanges();
        }

        document.getElementById("quick").addEventListener("mouseup", handleMouseUp);
        document.getElementById("passage-sub-questions").addEventListener("mouseup", handleMouseUp);
        // Lưu ý: các ô sửa trong modal sẽ được gắn sự kiện động trong hàm editParsedQuestion


        function removeHighlights(targetId = null) {
            const selector = targetId ? `#${targetId} .multi-select-highlight` : '.multi-select-highlight';
            const highlighted = document.querySelectorAll(selector);
            highlighted.forEach((span) => {
                span.replaceWith(...span.childNodes);
            });
            document.getElementById(targetId || 'quick')?.normalize();
        }

        function toggleInputType(type) {
            if (type === 'single') {
                document.getElementById('single-question-form').style.display = 'block';
                document.getElementById('passage-form').style.display = 'none';
            } else if (type === 'passage') {
                document.getElementById('single-question-form').style.display = 'none';
                document.getElementById('passage-form').style.display = 'block';
            }
        }

        // 🔹 Xử lý dán (paste) để loại bỏ định dạng không mong muốn
        function handlePaste(e) {
            e.preventDefault();
            const text = (e.originalEvent || e).clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
        }

        // Gắn sự kiện paste cho các ô contenteditable
        document.getElementById('quick').addEventListener('paste', handlePaste);
        document.getElementById('passage-text').addEventListener('paste', handlePaste);
        document.getElementById('passage-sub-questions').addEventListener('paste', handlePaste);
        document.getElementById('editQ').addEventListener('paste', handlePaste);
        document.getElementById('passageEditSubQuestions').addEventListener('paste', handlePaste);


        // 🔹 Xóa nội dung input
        function clearSingleInput() {
            const quickDiv = document.getElementById('quick');
            if (quickDiv.innerHTML.trim() !== '' && confirm('Bạn có chắc muốn xóa toàn bộ nội dung đã nhập?')) {
                quickDiv.innerHTML = '';
            }
        }

        function clearPassageInput() {
            const passageDiv = document.getElementById('passage-text');
            const subQuestionsDiv = document.getElementById('passage-sub-questions');
            if ((passageDiv.innerHTML.trim() !== '' || subQuestionsDiv.innerHTML.trim() !== '') && confirm('Bạn có chắc muốn xóa toàn bộ nội dung bài đọc và câu hỏi đã nhập?')) {
                passageDiv.innerHTML = '';
                subQuestionsDiv.innerHTML = '';
            }
        }

        // Tải câu hỏi khi trang được load
        loadQuestions();
    </script>
</body>

</html>